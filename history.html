    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="../../my-custom-ui.js"></script>
        <link rel="stylesheet" href="/sidebar.css">

        <style>
        * { font-family: 'Baloo 2', cursive; box-sizing: border-box; }

        /* =========================================
        1. C·∫§U TR√öC CHUNG
        ========================================= */
body { overflow: hidden; background: #eef2f7; margin: 0; min-height: 100vh; width: 100vw; display: flex; user-select: none; position: relative; }
        
        body::after { content: ""; position: fixed; width: 150vmax; height: 150vmax; top: -25%; left: -25%; z-index: -1; background-image: radial-gradient(circle at 20% 30%, #d0bcff 0%, transparent 40%), radial-gradient(circle at 80% 70%, #a1c4fd 0%, transparent 40%), radial-gradient(circle at 50% 50%, #c2e9fb 0%, transparent 50%); filter: blur(80px); animation: waveMovement 15s linear infinite; }
        @keyframes waveMovement { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .table-view { display: flex; width: 100%; min-height: 100vh; padding: 20px; gap: 10px; }
        .main-content { 
            flex-grow: 1; border: 3px solid #ffffff; box-shadow: -5px 5px 1px #b5b5ec; 
            background-color: #F8FAFC; height: calc(100vh - 40px); overflow-y: auto; 
            overflow-x: hidden; position: relative; border-radius: 15px; padding: 15px;
            scrollbar-width: none;
        }
        .main-content::-webkit-scrollbar { display: none; }

.content-wrapper {
  padding: 0;
  background: transparent;
  min-height: auto;
}



    .top-header { 
        display: flex; align-items: center; justify-content: space-between; 
        padding: 0 5px; height: 70px; 
    }


        /* HEADER */
        .page-title { font-size: 25px; font-weight: 700; color: #1a1a1a; margin: 0; display: flex; align-items: center; white-space: nowrap; }
        .page-title i { margin-right: 12px; color: #f39c12; }
        .top-header { display: flex; align-items: center; justify-content: space-between; padding: 0 25px; border-bottom: 1px solid #e0e0e0; height: 75px; background: #fff; flex-shrink: 0; }
        .header-right { display: flex; align-items: center; gap: 15px; position: relative; }

        /* LAYOUT 2 C·ªòT */
        .history-layout { display: flex; height: calc(100vh - 75px); width: 100%; }
        .history-left { width: 450px; min-width: 450px; background: #fff; border-right: 1px solid #e0e0e0; overflow-y: auto; display: flex; flex-direction: column; }
        .history-left::-webkit-scrollbar {
            display: none;
        }
        .history-right { flex: 1; background: #f8fafc; overflow-y: auto; display: flex; flex-direction: column; align-items: stretch; justify-content: flex-start; position: relative; }

        /* UI CHI TI·∫æT */
        .detail-header-bar { display: none; align-items: center; justify-content: space-between; padding: 12px 25px; background: #ffffff; border-bottom: 1px solid #eef2f7; position: sticky; top: 0; z-index: 10; height: 65px; }
        .detail-header-bar.active { display: flex; }
        .detail-header-info { display: flex; align-items: center; gap: 12px; }
        .detail-header-info i { font-size: 20px; color: #f39c12; background: #fff9f0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; }
        .detail-header-info span { font-weight: 600; font-size: 16px; color: #333; }

        .empty-state { margin: auto; text-align: center; color: #999; display: none; flex-direction: column; align-items: center; }
        .empty-state.show { display: flex; }
        .empty-state i { font-size: 50px; margin-bottom: 15px; color: #e0e0e0; }

        /* DROPDOWNS */
        .custom-date-wrapper { display: flex; align-items: center; background: #fff; border: 1px solid #e0e0e0; border-radius: 50px; padding: 5px 15px; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); height: 42px; position: relative; transition: 0.3s; }
        .custom-type-wrapper { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #e0e0e0; border-radius: 50px; padding: 0 20px; min-width: 180px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); height: 42px; cursor: pointer; position: relative; transition: 0.3s; }
        .custom-date-wrapper:hover, .custom-type-wrapper:hover { border-color: #f39c12; box-shadow: 0 4px 10px rgba(243, 156, 18, 0.15); }

        .c-dropdown { position: relative; cursor: pointer; text-align: center; }
        .c-selected { font-weight: 600; color: #333; padding: 5px 0; user-select: none; cursor: pointer; display: inline-block; text-align: center; }
        #displayMonth { width: 25px; }
        #displayYear { width: 40px; }
        .date-separator { font-weight: 700; color: #ccc; margin: 0 2px; }

        .c-options, .type-options { display: none; position: absolute; background: #fff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #f0f0f0; z-index: 1000; padding: 5px; }
        .c-options { top: 130%; left: 50%; transform: translateX(-50%); min-width: 80px; max-height: 300px; overflow-y: auto; animation: fadeInCentered 0.2s ease-out forwards; }
        .type-options { top: 130%; right: 0; left: auto; width: 100%; min-width: 200px; animation: fadeInDown 0.2s ease-out forwards; }
        
        .c-dropdown.active .c-options, .custom-type-wrapper.active .type-options { display: block; }
        .c-option-item { padding: 10px 15px; font-weight: 500; color: #555; border-radius: 10px; transition: 0.2s; cursor: pointer; display: flex; align-items: center; font-size: 14px; margin-bottom: 2px; justify-content: center; }
        .type-options .c-option-item { justify-content: flex-start; }
        .c-option-item:hover { background-color: #fff6e0; color: #d35400; }
        .c-option-item.selected { background-color: #f39c12; color: #fff; }

        @keyframes fadeInCentered { from { opacity: 0; transform: translate(-50%, -10px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* ITEMS LEFT */
        .history-item { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: all 0.2s; display: flex; align-items: flex-start; gap: 15px; background: #fff; }
        .history-item:hover { background: #f8fafc; }
        .history-item.active { background: #eff6ff; border-left: 4px solid #f39c12; }
        .history-item-icon-box { color: #f39c12; font-size: 18px; padding-top: 4px; }
        .history-item-body { flex: 1; }

        /* DETAIL RIGHT */
        .detail-summary { display: flex; justify-content: space-between; align-items: flex-start; padding: 20px 25px; background: #fff; border-bottom: 1px solid #f1f5f9; font-size: 14px; line-height: 1.6; color: #475569; }
                /* S·ª≠a l·∫°i class n√†y ƒë·ªÉ √¥ nh·ªè g·ªçn h∆°n */
        .summary-box { 
            background: #f8fafc; 
            border: 1px solid #e2e8f0; 
            padding: 6px 12px; /* Gi·∫£m ƒë·ªô d√†y tr√™n d∆∞·ªõi */
            border-radius: 6px; /* Bo g√≥c nh·∫π h∆°n */
            font-size: 13px; 
            color: #64748b; 
            display: inline-flex; /* ƒê·ªÉ canh gi·ªØa n·ªôi dung theo chi·ªÅu d·ªçc */
            align-items: center;
            gap: 5px;
            height: 34px; /* C·ªë ƒë·ªãnh chi·ªÅu cao cho ƒë·ªìng b·ªô */
            white-space: nowrap;
        }

        .summary-box strong, 
        .summary-box b { 
            color: #1e293b; 
            font-size: 13px; /* Ch·ªØ ƒë·∫≠m to b·∫±ng ch·ªØ th∆∞·ªùng cho c√¢n ƒë·ªëi */
            padding-top: 1px;
        }
        .product-table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 850px; }
        .product-table th { text-align: left; padding: 12px 15px; font-size: 13px; color: #64748b; background: #f8fafc; border-bottom: 2px solid #edf2f7; }
        .product-row td { padding: 12px 15px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }

        .qty-plus { color: #27ae60; font-weight: 700; }
        .qty-minus { color: #ef4444; font-weight: 700; }
        .google-account-pill { display: flex; align-items: center; gap: 8px; padding: 4px 4px 4px 12px; border: 1px solid #e0e0e0; border-radius: 50px; cursor: pointer; background: #fff; }
        .google-account-pill:hover { background: #f8f9fa; }
        .google-account-pill .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .user-pill-large { display: flex; align-items: center; gap: 10px; }
        .avatar-circle { width: 35px; height: 35px; background: #818cf8; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
        
        .action-icons i { cursor: pointer; transition: 0.2s; margin-left: 10px; color: #64748b; }
        .action-icons i:hover { color: #ef4444; }


        /* Th·∫ª Kh√°ch h√†ng x·ªãn x√≤ */
.customer-card-new {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid #e2e8f0;
    padding: 6px 15px 6px 6px;
    border-radius: 40px; /* Bo tr√≤n vi√™n thu·ªëc */
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    margin-left: auto;
    transition: all 0.2s ease;
    min-width: 180px;
    max-width: 250px;
}

.customer-card-new:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    transform: translateY(-1px);
    border-color: #cbd5e1;
}

/* Avatar kh√°ch h√†ng */
.cc-avatar-img {
    width: 38px; height: 38px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-right: 10px;
}

/* Avatar m·∫∑c ƒë·ªãnh (khi kh√¥ng c√≥ ·∫£nh) */
.cc-avatar-placeholder {
    width: 38px; height: 38px;
    border-radius: 50%;
    background: linear-gradient(135deg, #60a5fa, #2563eb); /* M√†u xanh gradient */
    color: #fff;
    display: flex; align-items: center; justify-content: center;
    margin-right: 10px;
    font-size: 16px;
    border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.cc-info { display: flex; flex-direction: column; line-height: 1.2; overflow: hidden; }
.cc-role { font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
.cc-name { font-size: 13px; color: #1e293b; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cc-phone { font-size: 11px; color: #64748b; font-family: monospace; }


/* --- 1. USER PROFILE TR√äN HEADER (M·ªöI) --- */
/* --- 1. USER PROFILE HEADER (Ch·ªânh l·∫°i cho chu·∫©n) --- */
.user-profile-box {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 30px; /* Bo tr√≤n gi·ªëng Google */
    transition: 0.2s;
    border: 1px solid transparent;
}
.user-profile-box:hover { 
    background: #f1f5f9; 
    border-color: #e2e8f0;
}

.u-avatar-circle {
    width: 36px; height: 36px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    background-color: #4f46e5;
    color: white;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 15px;
    border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    flex-shrink: 0;
}

.u-info-col { display: flex; flex-direction: column; line-height: 1.2; }
.u-name-text { font-weight: 700; color: #1e293b; font-size: 13px; }
.u-sub-text { font-size: 11px; color: #64748b; font-weight: 500; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* --- 2. TH·∫∫ NG∆Ø·ªúI TH·ª∞C THI (M·ªöI - GI·ªêNG TH·∫∫ KH√ÅCH) --- */
.executor-card {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid #e2e8f0;
    padding: 4px 12px 4px 4px;
    border-radius: 30px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.ec-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
    border: 1px solid #f1f5f9;
}

.ec-placeholder {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8b5cf6, #6d28d9); /* M√†u t√≠m admin */
    color: #fff;
    display: flex; align-items: center; justify-content: center;
    margin-right: 8px;
    font-size: 14px;
    font-weight: 600;
}

.ec-info { display: flex; flex-direction: column; line-height: 1.1; }
.ec-label { font-size: 9px; color: #94a3b8; text-transform: uppercase; font-weight: 700; }
.ec-name { font-size: 12px; color: #1e293b; font-weight: 700; }
/* ƒê√£ b·ªè cc-phone */



/* --- CSS CHO DROPDOWN KHO·∫¢NG TH·ªúI GIAN --- */
.history-period-container { position: relative; margin-right: 10px; }
.btn-history-period {
    background: #fff;
    border: 1px solid #cecece;
    border-radius: 12px;
    padding: 0 15px;
    height: 42px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
    white-space: nowrap;
    color: #1a1a1a;
}
.btn-history-period:hover { background: #f8fafc; transform: translateY(-1px); }
.btn-history-period i { color: #3b82f6; }

.history-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 10px);
    left: 0;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    width: 280px;
    z-index: 2000;
    padding: 8px;
    border: 1px solid #eef2f7;
    animation: fadeInDown 0.2s ease-out;
}
.history-dropdown.show { display: block; }

.history-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
.history-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.2s;
    margin-bottom: 2px;
}
.history-list-item:hover { background: #f1f5f9; }
.history-list-item .time-info { display: flex; flex-direction: column; gap: 4px; }
.history-list-item .time-title { font-weight: 800; color: #1e293b; font-size: 15px; }
.history-list-item .item-count { font-size: 12px; color: #64748b; font-weight: 500; }
.history-list-item i.fa-arrow-right { font-size: 12px; color: #cbd5e1; }

/* Quick Category Popup */
.quick-cat-popup {
    display: none; position: absolute; top: 50px; right: 20px;
    background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    width: 250px; z-index: 2000; border: 1px solid #e2e8f0;
}




/* --- CSS B·ªò L·ªåC VI√äN THU·ªêC (DROPDOWN C√ì ·∫¢NH) --- */
.history-filter-bar {
    padding: 12px 15px;
    background: #fff;
    border-bottom: 1px solid #f1f5f9;
    display: flex; flex-direction: column; gap: 8px;
}
.filter-row { display: flex; gap: 8px; }

.c-filter-dropdown { position: relative; flex: 1; }

.c-filter-btn {
    width: 100%; height: 38px;
    background: #f8fafc; border: 1px solid #e2e8f0;
    border-radius: 40px; /* Bo tr√≤n vi√™n thu·ªëc */
    padding: 0 18px;
    display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; font-size: 13px; font-weight: 600; color: #475569;
    transition: 0.2s;
}
.c-filter-btn:hover { border-color: #3b82f6; background: #fff; }

.btn-content { display: flex; align-items: center; gap: 8px; overflow: hidden; }
.btn-content img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid #e2e8f0; }

.c-filter-options {
    display: none; position: absolute; top: calc(100% + 5px);
    left: 0; right: 0; background: #fff; border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #eef2f7;
    z-index: 100; max-height: 250px; overflow-y: auto; padding: 5px;
}
.c-filter-options::-webkit-scrollbar {display:none;}
.c-filter-options.show { display: block; animation: fadeInDown 0.2s ease; }

.c-filter-item {
    display: flex; align-items: center; gap: 10px; padding: 8px 12px;
    border-radius: 8px; cursor: pointer; font-size: 13px; color: #334155;
}   
.c-filter-item:hover { background: #f1f5f9; outline: 1px solid #eeeeee; }
.c-filter-item img, .c-filter-item .mini-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
.c-filter-item .mini-avatar { background: #4f46e5; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }



/* --- UI CHO TH·∫∫ CHUY·ªÇN KHO (Route Card) --- */
.transfer-route-card {
    display: flex;
    align-items: center;
    background: #f0f9ff; /* N·ªÅn xanh d∆∞∆°ng nh·∫°t */
    border: 1px solid #bae6fd;
    padding: 8px 15px;
    border-radius: 12px;
    gap: 15px;
    min-width: 250px;
    position: relative;
    margin-left: auto; /* ƒê·∫©y sang ph·∫£i gi·ªëng th·∫ª kh√°ch */
}

.tr-node {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.tr-label {
    font-size: 10px;
    text-transform: uppercase;
    color: #64748b;
    font-weight: 700;
    margin-bottom: 2px;
}

.tr-name {
    font-size: 13px;
    font-weight: 700;
    color: #0369a1; /* Xanh ƒë·∫≠m */
    max-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.tr-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #0ea5e9;
    font-size: 14px;
    background: #fff;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Icon Warehouse */
.tr-icon {
    font-size: 16px;
    margin-bottom: 4px;
    color: #3b82f6;
}





/* H√†ng log c∆° b·∫£n */
.log-row {
    border-bottom: 1px solid #edf2f7;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
    background: #fff;
}

.log-row:hover {
    background: #f8fafc;
}

/* Khi h√†ng ƒë∆∞·ª£c active */
.log-row.active {
    background: #ebf8ff; /* M√†u xanh nh·∫°t khi ch·ªçn */
    border-left: 4px solid #3182ce;
}

/* Ph·∫ßn ghi ch√∫ m·∫∑c ƒë·ªãnh ·∫©n */
.note-detail {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s ease;
    background: #f1f5f9;
    font-size: 13px;
    color: #475569;
}

.log-row.active .note-detail {
    max-height: 100px; /* ƒê·ªô cao t·ªëi ƒëa khi m·ªü */
    padding: 10px 20px;
    border-top: 1px dashed #cbd5e1;
}

.note-inner {
    display: flex;
    align-items: center;
    gap: 10px;
}

.note-inner i {
    color: #64748b;
}


/* Style cho d√≤ng s·∫£n ph·∫©m khi ƒë∆∞·ª£c ch·ªçn */
.product-row {
    cursor: pointer;
    transition: background 0.2s;
}
.product-row:hover {
    background-color: #f8fafc !important;
}
.product-row.active {
    background-color: #f0f7ff !important;
}

/* Container ch·ª©a ghi ch√∫ */
.note-wrapper {
    max-height: 0;
    overflow: hidden;
    transition: all 0.3s ease-out;
    background: #fdfdfd;
}

.product-row.active + .note-row .note-wrapper {
    max-height: 100px;
    padding: 10px 15px;
    border-bottom: 1px solid #edf2f7;
}

.note-content-box {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    color: #4a5568;
    background: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px dashed #cbd5e1;
}

        </style>
    </head>
    <body>
        <div class="table-view">
            <div class="sidebar"></div>

            <div class="main-content content-wrapper">
                <!-- HEADER -->
                <div class="header-container top-header">
                    <h2 class="page-title">
                        <i class="fa-solid fa-box-archive" style="padding-right: 10px;"></i>L·ªãch s·ª≠
                    </h2>

                    <div class="header-right">
    <!-- N√öT KHO·∫¢NG TH·ªúI GIAN M·ªöI TH√äM -->
    <div class="history-period-container">
        <button class="btn-history-period" onclick="toggleHistoryDropdown(event)">
            <i class="fa-solid fa-clock-rotate-left"></i> C√°c kho·∫£ng th·ªùi gian t·ªìn t·∫°i
        </button>
        <div class="history-dropdown" id="historyDropdown">
            <ul class="history-list" id="historyList">
                <!-- D·ªØ li·ªáu s·∫Ω t·ª± load v√†o ƒë√¢y -->
            </ul>
        </div>
    </div>

    <!-- DATE PICKER C≈® -->
    <div class="custom-date-wrapper">
        <div class="c-dropdown" id="monthDropdown">
            <div class="c-selected" id="displayMonth">--</div>
            <div class="c-options" id="listMonth"></div>
        </div>
        <span class="date-separator">/</span>
        <div class="c-dropdown" id="yearDropdown">
            <div class="c-selected" id="displayYear">--</div>
            <div class="c-options" id="listYear"></div>
        </div>
    </div>
    
    <!-- TYPE PICKER C≈® -->
    <div class="custom-type-wrapper" id="typeWrapper">
        <span class="type-display" id="typeDisplay">T·∫•t c·∫£ giao d·ªãch</span>
        <i class="fa-solid fa-chevron-down type-icon"></i>
        <div class="type-options" id="typeOptions">
            <div class="c-option-item selected" data-value="all">T·∫•t c·∫£ giao d·ªãch</div>
            <div class="c-option-item" data-value="nhap">Nh·∫≠p kho</div>
            <div class="c-option-item" data-value="xuat">Xu·∫•t kho</div>
            <div class="c-option-item" data-value="kiemke">Ki·ªÉm k√™ kho</div>
            <div class="c-option-item" data-value="chuyen">Chuy·ªÉn kho</div>
        </div>
    </div>

    <!-- Quick Category Popup (Ch√®n ·∫©n) -->
    <div id="quickCategoryPopup" class="quick-cat-popup">
        <div class="quick-cat-search">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" id="quickCatSearch" placeholder="T√¨m danh m·ª•c..." onkeyup="filterQuickCategory()">
        </div>
        <ul id="quickCatList" class="quick-cat-list"></ul>
    </div>

    <div class="user-profile-box" id="userProfileTrigger" onclick="toggleUserMenu(event)">
        <div id="u-avatar" class="u-avatar-circle"></div>
        <div class="u-info-col">
            <div id="u-name" class="u-name-text">ƒêang t·∫£i...</div>
            <div id="u-email" class="u-sub-text">...</div>
        </div>
    </div>
</div>
                </div>

                <!-- MAIN LAYOUT -->
                <div class="history-layout">
                    <!-- B√äN TR√ÅI -->
<div class="history-left" id="historyLeftPanel">
    <!-- B·ªò L·ªåC M·ªöI TH√äM -->
<div class="history-filter-bar">
        <div class="filter-row">
            <!-- DROP ƒê·ªêI T∆Ø·ª¢NG (G·ªôp Nh√¢n vi√™n, Kh√°ch h√†ng, Nh√† cung c·∫•p) -->
            <div class="c-filter-dropdown" id="dropSubjectContainer" style="flex: 1;">
                <div class="c-filter-btn" onclick="toggleFilterDrop('dropSubjectOptions', event)">
                    <div class="btn-content" id="btnSubjectContent">
                        <i class="fa-solid fa-user-tag" ></i>
                        <span>T·∫•t c·∫£ ƒë·ªëi t∆∞·ª£ng</span>
                    </div>
                    <i class="fa-solid fa-chevron-down" style="font-size:10px; opacity:0.5"></i>
                </div>
                <!-- Menu n√†y s·∫Ω thay ƒë·ªïi n·ªôi dung ƒë·ªông -->
                <div class="c-filter-options" id="dropSubjectOptions"></div>
            </div>

            <!-- DROP KHUNG GI·ªú -->
            <div class="c-filter-dropdown" style="flex: 1;">
                <div class="c-filter-btn" onclick="toggleFilterDrop('dropTimeOptions', event)">
                    <div class="btn-content" id="btnTimeContent">
                        <i class="fa-solid fa-clock" style="color:#94a3b8"></i>
                        <span>T·∫•t c·∫£ khung gi·ªù</span>
                    </div>
                    <i class="fa-solid fa-chevron-down" style="font-size:10px; opacity:0.5"></i>
                </div>
                <div class="c-filter-options" id="dropTimeOptions"></div>
            </div>

            <button class="btn-clear-filter" onclick="clearFilters()" style="border-radius: 50%; width: 40px; height: 40px; flex:none; display:flex; align-items:center; justify-content:center; border: 1px solid #e2e8f0; background: #fff; cursor: pointer;">
                <i class="fa-solid fa-filter-circle-xmark" style="color: #64748b;"></i>
            </button>
        </div>
</div>

    <!-- Danh s√°ch c≈© -->
    <div id="historyListContainer"></div>
</div>

                    <!-- B√äN PH·∫¢I -->
                    <div class="history-right" id="historyRightPanel">
                        <div class="empty-state show">
                            <i class="fa-solid fa-box-open"></i>
                            <p>Ch·ªçn giao d·ªãch ƒë·ªÉ xem chi ti·∫øt</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>




    <!-- CH√ö √ù: ƒê√É X√ìA store-core.js ƒê·ªÇ TR√ÅNH L·ªñI MODULE -->
<script>
    (function() {
    function fastRenderUser() {
        const nameEl = document.getElementById('u-name');
        const emailEl = document.getElementById('u-email');
        const avatarEl = document.getElementById('u-avatar');
        
        // N·∫øu HTML ch∆∞a load k·ªãp th√¨ th√¥i, ƒë·ª£i s·ª± ki·ªán sau
        if (!nameEl || !avatarEl) return;

        const sName = localStorage.getItem('userName') || "User";
        const sEmail = localStorage.getItem('userEmail') || "";
        let sPic = localStorage.getItem('userPicture');
        const sRole = localStorage.getItem('userRole');

        // Logic ·∫£nh m·∫∑c ƒë·ªãnh cho Viewer
        if (sRole === 'viewer' && (!sPic || sPic === 'undefined' || sPic === 'null')) {
            const guestImgs = ["https://i.ibb.co/My2Y95Jg/1013261.png", "https://i.ibb.co/qYCgD0yv/10132601.png"];
            sPic = guestImgs[Math.floor(Math.random() * guestImgs.length)];
            localStorage.setItem('userPicture', sPic);
        }

        // 1. ƒêi·ªÅn T√™n
        nameEl.textContent = sName;

        // 2. ƒêi·ªÅn Email ho·∫∑c Vai tr√≤
        if (emailEl) {
            // N·∫øu l√† Admin th√¨ hi·ªán ch·ªØ Qu·∫£n tr·ªã vi√™n cho oai, c√≤n l·∫°i hi·ªán email
            if (sRole === 'super_admin' || sRole === 'owner') {
                emailEl.textContent = "Qu·∫£n tr·ªã vi√™n";
                emailEl.style.color = "#4f46e5";
            } else {
                emailEl.textContent = sEmail;
            }
        }
   
        // 3. ƒêi·ªÅn ·∫¢nh
// 3. ƒêi·ªÅn ·∫¢nh (S·ª≠a l·∫°i)
if (sPic && sPic.startsWith('http') && sPic !== 'undefined' && sPic !== 'null') {
    // X√≥a ch·ªØ c√°i c≈© n·∫øu c√≥ v√† ch√®n th·∫ª img ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªÉn th·ªã
    avatarEl.innerHTML = `<img src="${sPic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
    avatarEl.style.backgroundColor = "transparent";
    avatarEl.style.border = "none";
} else {
    avatarEl.innerHTML = sName.charAt(0).toUpperCase();
    avatarEl.style.backgroundImage = "none";
    avatarEl.style.backgroundColor = "#4f46e5";
    avatarEl.style.display = "flex";
    avatarEl.style.alignItems = "center";
    avatarEl.style.justifyContent = "center";
    avatarEl.style.color = "white";
}

    }

    // Ch·∫°y ngay l·∫≠p t·ª©c
    fastRenderUser();
    // Ch·∫°y l·∫°i khi HTML ƒë√£ load xong (Kh·∫Øc ph·ª•c l·ªói Ctrl+F5)
    document.addEventListener('DOMContentLoaded', fastRenderUser);

    // H√†m toggle menu
    window.toggleMenu = (id, e) => {
        if(e) e.stopPropagation();
        document.getElementById(id)?.classList.toggle('active');
    };
    window.toggleUserMenu = (e) => window.toggleMenu('userPopover', e);
})();



(function() {
    const sidebarContainer = document.querySelector('.sidebar');
    if (!sidebarContainer) return;

    fetch('/components/Side-Bar.html')
        .then(res => res.text())
        .then(html => {
            sidebarContainer.innerHTML = html;

            // Ch·ªâ ch·∫°y script Module m·ªôt l·∫ßn duy nh·∫•t
            sidebarContainer.querySelectorAll("script").forEach(oldScript => {
                const newScript = document.createElement("script");
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.textContent = oldScript.textContent;
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        })
        .catch(err => console.error("Sidebar load error:", err));
})();


</script>





<script type="module">
 const ADMIN_LOGO = localStorage.getItem('admin_logo_url');        
// --- KHAI B√ÅO BI·∫æN CHO B·ªò L·ªåC ---
let filterState = {
    subjectType: 'all', // all, staff, customer, supplier
    subjectValue: '',   // email ho·∫∑c ID kh√°ch
    timeRange: ''
};

    // 1. IMPORT ƒê·∫¶Y ƒê·ª¶
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
        getFirestore, doc, onSnapshot, updateDoc, getDoc, getDocs, orderBy,
        collection, query, where, limit 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";   

    // 2. C·∫§U H√åNH FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyCYOo3FUewsYVIVy-egCKxZfVDUjLmGAQo",
        authDomain: "warehouse-management-77290.firebaseapp.com",
        projectId: "warehouse-management-77290",
        storageBucket: "warehouse-management-77290.firebasestorage.app",
        messagingSenderId: "881477949386",
        appId: "1:881477949386:web:7133b60dd2e0bc5d9ca133",
        measurementId: "G-ESPCYW3ZN9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const STORE_ID = localStorage.getItem('current_store_id');
    if (!STORE_ID) {
        alert("Ch∆∞a ch·ªçn c·ª≠a h√†ng!");
        window.location.href = '/store.html';
    }

// --- BI·∫æN TO√ÄN C·ª§C ---
let logs = [];
let products = [];
let productMap = {}; 
let selectedGroupId = null;

let allStaff = [];      
let allCustomers = [];  
let allSuppliers = []; // Th√™m d√≤ng n√†y
let customerMap = {}; 
let supplierMap = {};  // Th√™m d√≤ng n√†y
let userMap = {};
let storeOwnerEmail = "";


// Bi·∫øn l∆∞u t·∫°m ƒë·ªÉ g·ªôp d·ªØ li·ªáu
let oldLogsData = [];
let newLogsData = [];
let logsGlobal = {
    old: [],        // D·ªØ li·ªáu c≈© (Array)
    import: [],     // D·ªØ li·ªáu nh·∫≠p m·ªõi
    export: [],     // D·ªØ li·ªáu xu·∫•t m·ªõi
    audit: [],      // D·ªØ li·ªáu ki·ªÉm k√™ m·ªõi
    transfer: []    // D·ªØ li·ªáu chuy·ªÉn kho m·ªõi
};


    const now = new Date();
    let selectedYear = now.getFullYear();
    let selectedMonth = now.getMonth() + 1;
    let currentType = 'all';

    const formatVND = (num) => Number(num || 0).toLocaleString('vi-VN') + '‚Ç´';
    const NO_IMAGE_URL = `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='#f8fafc'/><path fill='#cbd5e1' d='M392 64H120c-30.9 0-56 25.1-56 56v272c0 30.9 25.1 56 56 56h272c30.9 0 56-25.1 56-56V120c0-30.9-25.1-56-56-56zm24 328c0 13.3-10.7 24-24 24H120c-13.3 0-24-10.7-24-24V120c0-13.3 10.7-24 24-24h272c13.3 0 24 10.7 24 24v272z'/></svg>`;

    // Quy·ªÅn h·∫°n
// --- C·∫¨P NH·∫¨T LOGIC QUY·ªÄN H·∫†N ---
let canEditHistory = false;
const userEmail = localStorage.getItem('userEmail');
const userRole = localStorage.getItem('userRole');

// Ki·ªÉm tra quy·ªÅn ngay l·∫≠p t·ª©c t·ª´ localStorage
if (userRole === 'super_admin' || userRole === 'owner' || userRole === 'Ch·ªß s·ªü h·ªØu') {
    canEditHistory = true;
}

function listenPermissions() {
    if (!STORE_ID || !userEmail) return;
    const userId = `${STORE_ID}_${userEmail.replace(/\./g, '_')}`;

    // L·∫Øng nghe thay ƒë·ªïi quy·ªÅn t·ª´ Firestore
onSnapshot(query(collection(db, "gmail_personnel"), where("storeId", "==", STORE_ID)), (snapshot) => {
    window.allStaff = snapshot.docs.map(doc => ({
        name: doc.data().name || "Nh√¢n vi√™n",
        email: doc.data().email || ""
    }));
    // Ghi v√†o userMap ƒë·ªÉ hi·ªán avatar
    snapshot.docs.forEach(doc => {
        const u = doc.data();
        if (u.email) window.userMap[u.email.trim().toLowerCase()] = u.photo || u.avatar || "";
    });
    console.log("ƒê√£ t·∫£i nh√¢n vi√™n:", window.allStaff.length);
    window.updateFilterOptions(); // V·∫Ω l·∫°i menu l·ªçc ngay khi c√≥ data
});
}
listenPermissions();

    // ============================================================
    // 4. LOAD D·ªÆ LI·ªÜU REALTIME
    // ============================================================
// Bi·∫øn to√†n c·ª•c ƒë·ªÉ ch·ª©a danh s√°ch kh√°ch (Th√™m v√†o ƒë·∫ßu file c√πng ch·ªó v·ªõi logs, products)


// ============================================================
    // 4. LOAD D·ªÆ LI·ªÜU REALTIME (ƒê√É S·ª¨A L·ªñI HI·ªÇN TH·ªä)
    // ============================================================
    function initRealTimeData() {
        if (!STORE_ID) return;

        // 1. L·∫§Y TH√îNG TIN C·ª¨A H√ÄNG
        getDoc(doc(db, "warehouse_stores", STORE_ID)).then(snap => {
            if (snap.exists()) {
                storeOwnerEmail = (snap.data().ownerEmail || "").trim().toLowerCase();
            }
        });

        // 2. L·∫ÆNG NGHE KH√ÅCH H√ÄNG (ƒê√É S·ª¨A: CH·ªà L·∫§Y C·ª¶A C·ª¨A H√ÄNG HI·ªÜN T·∫†I)
        onSnapshot(query(collection(db, "customers"), where("storeId", "==", STORE_ID)), (snapshot) => {
            window.allCustomers = snapshot.docs.map(doc => ({
                id: doc.id,
                name: doc.data().name || "Kh√°ch l·∫°",
                img: doc.data().image || ""
            }));
            
            // Reset map tra c·ª©u c≈© ƒë·ªÉ tr√°nh d·ªØ li·ªáu r√°c
            window.customerMap = {}; 

            // Ghi v√†o map tra c·ª©u
            window.allCustomers.forEach(c => {
                window.customerMap[c.id] = c;
                if(c.name) window.customerMap[c.name.toLowerCase().trim()] = c;
            });
            
            console.log("ƒê√£ t·∫£i kh√°ch h√†ng:", window.allCustomers.length);
            
            if (typeof updateFilterOptions === 'function') updateFilterOptions(); // V·∫Ω l·∫°i menu l·ªçc
            mergeAndReloadLogs(); // C·∫≠p nh·∫≠t l·∫°i l·ªãch s·ª≠ hi·ªÉn th·ªã
        });

        let allSuppliers = [];
        let supplierMap = {};

        // L·∫ÆNG NGHE NH√Ä CUNG C·∫§P
  // T√¨m ƒëo·∫°n onSnapshot c·ªßa suppliers trong initRealTimeData v√† thay b·∫±ng:
onSnapshot(query(collection(db, "suppliers"), where("storeId", "==", STORE_ID)), (snapshot) => {
    window.allSuppliers = [];
    window.supplierMap = {}; 
    
    snapshot.docs.forEach(doc => {
        const data = doc.data();
        const info = {
            id: doc.id,
            name: data.name || "NCC kh√¥ng t√™n",
            img: data.image || ""
        };
        window.allSuppliers.push(info);
        // Map d√πng ƒë·ªÉ tra c·ª©u khi hi·ªÉn th·ªã l·ªãch s·ª≠
        window.supplierMap[doc.id] = info;
        if (data.name) window.supplierMap[data.name.toLowerCase().trim()] = info;
    });

    console.log("üî• ƒê√£ t·∫£i NCC:", window.allSuppliers.length, window.allSuppliers);
    
    // √âp giao di·ªán c·∫≠p nh·∫≠t l·∫°i n·∫øu ƒëang m·ªü menu l·ªçc
    if (typeof updateFilterOptions === 'function') updateFilterOptions();
    mergeAndReloadLogs(); 
}, (error) => {
    console.error("L·ªói l·∫•y NCC:", error);
});

        // 3. L·∫ÆNG NGHE NH√ÇN S·ª∞
        onSnapshot(query(collection(db, "gmail_personnel"), where("storeId", "==", STORE_ID)), (snapshot) => {
            userMap = {}; 
            allStaff = [];
            snapshot.docs.forEach(doc => {
                const u = doc.data();
                const finalPic = u.photo || u.photoURL || u.avatar || "";
                allStaff.push({ name: u.name, email: u.email });
                if (u.email && finalPic) userMap[u.email.trim().toLowerCase()] = finalPic;
            });
            if (typeof updateFilterOptions === 'function') updateFilterOptions();
            mergeAndReloadLogs(); // V·∫Ω l·∫°i khi nh√¢n vi√™n thay ƒë·ªïi
        });

        // 4. L·∫ÆNG NGHE S·∫¢N PH·∫®M
        onSnapshot(query(collection(db, "products"), where("storeId", "==", STORE_ID)), (snapshot) => {
            productMap = {};
            snapshot.docs.forEach(doc => {
                const p = doc.data();
                const info = { img: p.img, category: p.category, cost: p.cost };
                if (p.sku) productMap[String(p.sku).trim().toLowerCase()] = info;
                if (p.name) productMap[String(p.name).trim().toLowerCase()] = info;
            });
            mergeAndReloadLogs(); // V·∫Ω l·∫°i khi s·∫£n ph·∫©m thay ƒë·ªïi
        });

        // ==========================================================
        // 5. L·∫ÆNG NGHE L·ªäCH S·ª¨ (QUAN TR·ªåNG: PH·∫¶N N√ÄY ƒê√É B·ªä THI·∫æU TR∆Ø·ªöC ƒê√ì)
        // ==========================================================

        // A. L·∫Øng nghe d·ªØ li·ªáu C≈® (Array trong document ch√≠nh)
        onSnapshot(doc(db, "warehouse_history_logs", STORE_ID), (docSnap) => {
            if (docSnap.exists()) {
                logsGlobal.old = (docSnap.data().logs || []).map(item => ({...item, source: 'old'}));
            } else {
                logsGlobal.old = [];
            }
            mergeAndReloadLogs();
        });

        // B. H√†m ph·ª• tr·ª£ l·∫Øng nghe Sub-collection (M·ªõi)
        const listenToSubCol = (colName, keyName) => {
            const q = query(
                collection(db, "warehouse_history_logs", STORE_ID, colName), 
                orderBy("timestamp", "desc"),
                limit(200) // Gi·ªõi h·∫°n 200 d√≤ng m·ªõi nh·∫•t m·ªói lo·∫°i
            );

            onSnapshot(q, (snapshot) => {
                logsGlobal[keyName] = snapshot.docs.map(d => ({
                    id: d.id,        // ID document ƒë·ªÉ x√≥a
                    source: colName, // Ngu·ªìn ƒë·ªÉ bi·∫øt x√≥a ·ªü ƒë√¢u
                    ...d.data()
                }));
                mergeAndReloadLogs();
            });
        };

        // C. K√≠ch ho·∫°t l·∫Øng nghe 4 collection m·ªõi
        listenToSubCol('import_log', 'import');
        listenToSubCol('export_log', 'export');
        listenToSubCol('audit_log', 'audit');
        listenToSubCol('transfer_log', 'transfer');
    
    
// H√†m b·∫≠t/t·∫Øt ghi ch√∫ cho s·∫£n ph·∫©m trong b·∫£ng chi ti·∫øt
window.toggleProductNote = function(event, element) {
    event.stopPropagation();
    
    // N·∫øu d√≤ng n√†y ƒëang m·ªü th√¨ ƒë√≥ng l·∫°i
    if (element.classList.contains('active')) {
        element.classList.remove('active');
    } else {
        // ƒê√≥ng t·∫•t c·∫£ c√°c d√≤ng kh√°c tr∆∞·ªõc khi m·ªü d√≤ng m·ªõi
        document.querySelectorAll('.product-row.active').forEach(row => {
            row.classList.remove('active');
        });
        // M·ªü d√≤ng ƒë∆∞·ª£c click
        element.classList.add('active');
    }
};

// X·ª≠ l√Ω click ra ngo√†i ƒë·ªÉ ƒë√≥ng t·∫•t c·∫£ ghi ch√∫
window.addEventListener('click', function(e) {
    if (!e.target.closest('.product-row')) {
        document.querySelectorAll('.product-row.active').forEach(row => {
            row.classList.remove('active');
        });
    }
});

    // ==========================================================
    // 5. L·∫ÆNG NGHE L·ªäCH S·ª¨ (CH·∫æ ƒê·ªò HYBRID: C≈® + M·ªöI)
    // ==========================================================

    // A. L·∫Øng nghe d·ªØ li·ªáu C≈® (Array trong document - File b·ªã gi·ªõi h·∫°n)


// --- H√ÄM TR·ªòN D·ªÆ LI·ªÜU & V·∫º GIAO DI·ªÜN ---
// --- TH√äM BI·∫æN TIMER ---
let debounceTimer = null;

// --- S·ª¨A H√ÄM mergeAndReloadLogs ---
function mergeAndReloadLogs() {
    // H·ªßy l·ªánh v·∫Ω tr∆∞·ªõc ƒë√≥ n·∫øu n√≥ ch∆∞a k·ªãp ch·∫°y
    if (debounceTimer) clearTimeout(debounceTimer);

    // ƒê·∫∑t l·ªánh m·ªõi: "Ch·ªù 100ms n·ªØa n·∫øu kh√¥ng ai g·ªçi th√¨ tao m·ªõi ch·∫°y"
    debounceTimer = setTimeout(() => {
        console.log("Bat dau render UI..."); // Log ƒë·ªÉ ki·ªÉm tra
        
        logs = [
            ...logsGlobal.old,
            ...logsGlobal.import,
            ...logsGlobal.export,
            ...logsGlobal.audit,
            ...logsGlobal.transfer
        ];

        logs.sort((a, b) => b.timestamp - a.timestamp);

        reloadHistory(); 
        if (typeof updateExistencePeriods === 'function') updateExistencePeriods();
        
        // C·∫≠p nh·∫≠t b·ªô l·ªçc
        updateFilterOptions(); 
        renderTimeFilterOptions();
        
        // ·∫®n loading n·∫øu c√≥ (n·∫øu b·∫°n mu·ªën th√™m loading spinner sau n√†y)
    }, 100); // 100ms l√† ƒë·ªô tr·ªÖ
}}



    // ============================================================
    // 5. X·ª¨ L√ù KH·ªöP D·ªÆ LI·ªÜU & GOM NH√ìM (C√ì T√çNH CHI·∫æT KH·∫§U)
    // ============================================================
// ============================================================
// 5. X·ª¨ L√ù KH·ªöP D·ªÆ LI·ªÜU & GOM NH√ìM (ƒê√É S·ª¨A LOGIC KI·ªÇM K√ä)
// ============================================================
function getGroupedHistory() {
    const filteredLogs = logs.filter(log => {
        const d = new Date(log.timestamp);
        
        // 1. L·ªçc theo Th√°ng/NƒÉm
        const matchYear = d.getFullYear() === selectedYear;
        const matchMonth = (d.getMonth() + 1) === selectedMonth;
        if (!matchYear || !matchMonth) return false;

        // 2. L·ªçc theo Lo·∫°i (Nh·∫≠p/Xu·∫•t/Ki·ªÉm k√™/Chuy·ªÉn)
        let matchType = true;
        const type = (log.type || '').toLowerCase();
        
        if (currentType === 'nhap') matchType = (type === 'nhap' || type === 'import');
        else if (currentType === 'xuat') matchType = (type === 'xuat' || type === 'export');
        else if (currentType === 'kiemke') matchType = (type === 'kiemke' || type.includes('check') || type.includes('audit'));
        else if (currentType === 'chuyen') matchType = (type === 'chuyen' || type.includes('transfer'));
        
        if (!matchType) return false;

        // 3. Logic nh·∫≠n di·ªán kh√°ch h√†ng ƒë·ªÉ L·ªçc
        // N·∫øu l√† Ki·ªÉm k√™ th√¨ b·ªè qua logic l·ªçc kh√°ch (tr·ª´ khi ƒëang l·ªçc 'T·∫•t c·∫£ kh√°ch')
        const isKiemKe = (type === 'kiemke' || type.includes('check') || type.includes('audit'));
        
        if (!isKiemKe) {
            const custIdInLog = log.customerId || ""; 
            const rawNameInLog = (log.supplier || log.customer || 'Kh√°ch l·∫ª').trim();
            const latestInfo = customerMap[custIdInLog] || customerMap[rawNameInLog.toLowerCase()];
            const nameForFilter = latestInfo ? latestInfo.name.toLowerCase() : rawNameInLog.toLowerCase();
            
            const matchCust = !filterState.customer || nameForFilter.includes(filterState.customer.toLowerCase());
            if (!matchCust) return false;
        } else {
            // N·∫øu ƒëang ch·ªçn filter kh√°ch h√†ng c·ª• th·ªÉ m√† g·∫∑p phi·∫øu ki·ªÉm k√™ -> ·∫®n phi·∫øu ki·ªÉm k√™
            if (filterState.customer && filterState.customer !== '') return false;
        }

        // 4. L·ªçc theo Ng∆∞·ªùi th·ª±c thi
        const logEmail = (log.userEmail || log.email || "").toLowerCase().trim();
        const logName = (log.userName || log.name || "").toLowerCase().trim();
        const filterVal = (filterState.executor || "").toLowerCase().trim();
        let matchExec = true; 
        
        // Trong filteredLogs = logs.filter(...)
        // T√¨m trong getGroupedHistory, ƒëo·∫°n x·ª≠ l√Ω filterState.subjectType !== 'all'
        // T√¨m trong getGroupedHistory, ƒëo·∫°n x·ª≠ l√Ω filterState.subjectType !== 'all'
        if (filterState.subjectType !== 'all') {
            const type = (log.type || '').toLowerCase();
            const isKiemKe = (type === 'kiemke' || type.includes('check') || type.includes('audit'));

            if (filterState.subjectType === 'staff') {
                const logEmail = (log.userEmail || log.email || "").toLowerCase().trim();
                const logName = (log.userName || log.name || "").toLowerCase().trim();
                const val = filterState.subjectValue;
                if (val === 'admin') {
                    if (!(logName.includes('admin') || logEmail === storeOwnerEmail)) return false;
                } else {
                    if (logEmail !== val && logName !== val) return false;
                }
            } 
            else if (filterState.subjectType === 'supplier' || filterState.subjectType === 'customer') {
                if (isKiemKe) return false; // Ki·ªÉm k√™ kh√¥ng c√≥ ƒë·ªëi t√°c

                const logCustId = log.customerId || ""; 
                const logRawName = (log.supplier || log.customer || 'Kh√°ch l·∫ª').trim().toLowerCase();
                
                // Ch·ªçn Map t∆∞∆°ng ·ª©ng ƒë·ªÉ tra c·ª©u
                const currentMap = (filterState.subjectType === 'supplier') ? supplierMap : customerMap;
                
                // T√¨m th√¥ng tin ƒë·ªëi t√°c t·ª´ ID ho·∫∑c T√™n trong Log
                const matchInfo = currentMap[logCustId] || currentMap[logRawName];
                const finalNameInLog = matchInfo ? matchInfo.name.toLowerCase() : logRawName;

                // So s√°nh v·ªõi gi√° tr·ªã ƒëang l·ªçc (subjectValue l√† t√™n ƒë·ªëi t√°c vi·∫øt th∆∞·ªùng)
                if (!finalNameInLog.includes(filterState.subjectValue)) return false;
            }
        }

        // 4. L·ªçc theo Khung gi·ªù (Gi·ªØ nguy√™n)
        
        const matchTime = !filterState.timeRange || d.getHours() === parseInt(filterState.timeRange);
        if (!matchTime) return false;

        return true;
    });

    const groups = {};
    filteredLogs.forEach(log => {
        const d = new Date(log.timestamp);
        const type = (log.type || '').toLowerCase();
        
        // --- X√ÅC ƒê·ªäNH LO·∫†I PHI·∫æU ƒê·ªÇ G√ÅN T√äN HI·ªÇN TH·ªä ---
        const isKiemKe = (type === 'kiemke' || type.includes('check') || type.includes('audit'));
        
        let displayPillName = "";
        let displayImg = "";
        let isDeleted = false;
        let custId = "";

        if (isKiemKe) {
            // TR∆Ø·ªúNG H·ª¢P KI·ªÇM K√ä: Kh√¥ng c√≥ kh√°ch h√†ng
       
            displayImg = ""; // Kh√¥ng hi·ªÉn th·ªã ·∫£nh
            isDeleted = false;
        } else {
            // TR∆Ø·ªúNG H·ª¢P NH·∫¨P/XU·∫§T/CHUY·ªÇN: Tra c·ª©u kh√°ch/ƒë·ªëi t√°c
            custId = log.customerId || "";
            const rawName = (log.supplier || log.customer || 'Kh√°ch l·∫ª').trim();
            
            const latestInfo = customerMap[custId] || customerMap[rawName.toLowerCase()];
            
            displayPillName = latestInfo ? latestInfo.name : rawName;
            displayImg = latestInfo ? latestInfo.img : "";
            isDeleted = (rawName !== 'Kh√°ch l·∫ª' && !latestInfo && custId !== "");
        }

        const executorEmail = (log.userEmail || log.email || "").trim().toLowerCase();
        const executorName = (log.userName || 'Admin').trim();
        
        // T·∫†O KH√ìA NH√ìM (Th√™m isKiemKe v√†o key ƒë·ªÉ kh√¥ng b·ªã tr·ªôn l·∫´n)
        const groupKey = `${d.getDate()}_${d.getHours()}_${log.type}_${isKiemKe ? 'Audit' : displayPillName}_${executorEmail}`;

        if (!groups[groupKey]) {
            groups[groupKey] = {
                id: groupKey, 
                rawTimestamp: log.timestamp,
                dateStr: `${d.getDate()} thg ${d.getMonth() + 1}, ${d.getFullYear()}`,
                hour: d.getHours(), 
                type: log.type, 
                user: executorName, 
                email: executorEmail,
                
                // C√°c tr∆∞·ªùng hi·ªÉn th·ªã ƒë·ªëi t√°c
                customerId: custId,
                supplier: displayPillName, 
                customerImg: displayImg,   
                isCustomerDeleted: isDeleted,
                
                grpTotalAmount: 0, 
                grpNetAdjustment: 0, 
                grpSubTotal: 0, 
                itemsList: [] 
            };
        }

        const group = groups[groupKey];
        
        // TRA C·ª®U S·∫¢N PH·∫®M
        const logSku = String(log.sku || '').trim().toLowerCase();
        const logNameStr = String(log.name || '').trim().toLowerCase();
        const prodInfo = productMap[logSku] || productMap[logNameStr];
        
        const finalProdImg = (prodInfo && prodInfo.img && prodInfo.img.length > 20) ? prodInfo.img : (log.img || NO_IMAGE_URL);
        const finalCategory = (prodInfo && prodInfo.category) ? prodInfo.category : (log.category || '---');
        
        const itemQty = Number(log.qty || 0); // V·ªõi ki·ªÉm k√™: ƒë√¢y l√† s·ªë l·ªách (+/-)
        const itemPrice = Number(log.price || 0);
        const itemCost = Number(log.cost || (prodInfo ? prodInfo.cost : 0) || 0);
        const netAdjustment = Number(log.extraFee || 0) - Number(log.discount || 0);
        
        // T√≠nh to√°n t·ªïng ti·ªÅn (Ki·ªÉm k√™ th∆∞·ªùng gi√° = 0 n√™n kh√¥ng ·∫£nh h∆∞·ªüng Amount)
        group.grpTotalAmount += (itemQty * itemPrice) + netAdjustment;
        group.grpNetAdjustment += netAdjustment;
        group.grpSubTotal += (itemQty * itemCost);
        
        group.itemsList.push({
            id: log.id || null,       
            source: log.source || 'old', 
            sku: log.sku, 
            name: log.name, 
            img: finalProdImg, 
            category: finalCategory,
            price: itemPrice, 
            cost: itemCost, 
            netAdjustment: netAdjustment,
            oldStock: log.oldStock || 0, 
            newStock: log.newStock || 0, 
            qty: itemQty,
            exactTime: log.timestamp,
            note: log.note || "" // <--- TH√äM D√íNG N√ÄY ƒê·ªÇ NH·∫¨N D·ªÆ LI·ªÜU GHI CH√ö
        });
    });

    return Object.values(groups).sort((a, b) => b.rawTimestamp - a.rawTimestamp);
}


// --- X·ª¨ L√ù B·ªò L·ªåC CHI TI·∫æT ---
window.handleFilterChange = function() {
    filterState.customer = document.getElementById('filterCustomer').value;
    filterState.executor = document.getElementById('filterExecutor').value;
    filterState.timeRange = document.getElementById('filterTime').value;
    reloadHistory();
};


// H√†m l·∫•y ·∫£nh kh√¥ng c·∫ßn d√°n link th·ªß c√¥ng
function getAvatarDynamic(email, name, type = 'staff') {
    const emailKey = (email || "").toLowerCase().trim();
    const nameKey = (name || "").toLowerCase().trim();
    const storeOwner = (storeOwnerEmail || "").toLowerCase();

    // 1. KI·ªÇM TRA ADMIN (Theo Email ch·ªß ho·∫∑c T√™n c√≥ ch·ªØ admin)
    const isAdmin = nameKey.includes('admin') || 
                    nameKey.includes('ch·ªß s·ªü h·ªØu') || 
                    emailKey === storeOwner || 
                    emailKey === 'admin';

    if (isAdmin) return localStorage.getItem('admin_logo_url');

    // 2. KI·ªÇM TRA NH√ÇN VI√äN
    if (type === 'staff') {
        // ∆Øu ti√™n 1: Tra trong danh b·∫° userMap (·∫¢nh t·ª´ Firebase)
        if (userMap[emailKey]) return userMap[emailKey];
        if (userMap[nameKey]) return userMap[nameKey];

        // ∆Øu ti√™n 2: N·∫øu l√† ch√≠nh m√¨nh ƒëang ƒëƒÉng nh·∫≠p
        const myEmail = (localStorage.getItem('userEmail') || "").toLowerCase();
        if (emailKey === myEmail) return localStorage.getItem('userPicture');
    }

    return "";
}



// --- 1. TOGGLE DROPDOWN ---
window.toggleFilterDrop = function(id, e) {
    if(e) e.stopPropagation();
    const target = document.getElementById(id);
    const isShowing = target.classList.contains('show');
    
    // ƒê√≥ng t·∫•t c·∫£ menu kh√°c
    document.querySelectorAll('.c-filter-options').forEach(opt => opt.classList.remove('show'));
    
    // M·ªü menu ƒë∆∞·ª£c nh·∫•n
    if (!isShowing) target.classList.add('show');
};

// ƒê√≥ng menu khi b·∫•m ra ngo√†i v√πng l·ªçc
window.addEventListener('click', function(e) {
    if (!e.target.closest('.c-filter-dropdown')) {
        document.querySelectorAll('.c-filter-options').forEach(opt => opt.classList.remove('show'));
    }
});

// --- 2. C·∫¨P NH·∫¨T OPTIONS C√ì H√åNH ·∫¢NH ---
// Bi·∫øn t·∫°m ƒë·ªÉ qu·∫£n l√Ω vi·ªác ƒëang ·ªü menu c·∫•p n√†o: 'root', 'staff', 'customer', 'supplier'



// --- H√ÄM T·∫†O DANH S√ÅCH GI·ªú T·ª∞ ƒê·ªòNG ---
function renderTimeFilterOptions() {
    const timeBox = document.getElementById('dropTimeOptions');
    if (!timeBox) return;

    let html = `<div class="c-filter-item" onclick="selectTime('', 'T·∫•t c·∫£ khung gi·ªù')"><i class="fa-solid fa-clock" style="color:#94a3b8"></i>T·∫•t c·∫£ khung gi·ªù</div>`;
    
    // T√¨m c√°c khung gi·ªù th·ª±c t·∫ø c√≥ trong Logs c·ªßa th√°ng/nƒÉm ƒëang ch·ªçn
    const hoursInLogs = new Set();
    logs.forEach(log => {
        const d = new Date(log.timestamp);
        if (d.getFullYear() === selectedYear && (d.getMonth() + 1) === selectedMonth) {
            hoursInLogs.add(d.getHours());
        }
    });

    // Chuy·ªÉn Set th√†nh m·∫£ng v√† s·∫Øp x·∫øp t·ª´ s·ªõm ƒë·∫øn mu·ªôn
    const sortedHours = Array.from(hoursInLogs).sort((a, b) => a - b);

    if (sortedHours.length === 0) {
        html += `<div class="c-filter-item" style="color:#94a3b8; font-style:italic; font-size:12px; justify-content:center;">Kh√¥ng c√≥ d·ªØ li·ªáu gi·ªù</div>`;
    } else {
        sortedHours.forEach(h => {
            const label = `${h.toString().padStart(2, '0')}:00 - ${(h + 1).toString().padStart(2, '0')}:00`;
            html += `
                <div class="c-filter-item" onclick="selectTime('${h}', '${label}')">
                    <div class="mini-avatar" style="background:transparent; color:#64748b; display:flex; align-items:center; justify-content:center;">
                        <i class="fa-regular fa-clock"></i>
                    </div>
                    <span>${label}</span>
                </div>`;
        });
    }
    timeBox.innerHTML = html;
}

// ƒê·ª´ng qu√™n g·ªçi h√†m n√†y cu·ªëi h√†m updateFilterOptions


let currentSubjectView = 'root'; 

window.updateFilterOptions = function() {
    const ADMIN_LOGO_URL = localStorage.getItem('admin_logo_url');
    const subjectBox = document.getElementById('dropSubjectOptions');
    if (!subjectBox) return;

    if (currentSubjectView === 'root') {
        // --- C·∫§P 1: MENU CH√çNH ---
        subjectBox.innerHTML = `
            <div class="c-filter-item" onclick="selectSubject('all', '', 'T·∫•t c·∫£ ƒë·ªëi t∆∞·ª£ng', null)" style="font-weight:700; border-bottom:1px solid #f1f5f9;">
                <i class="fa-solid fa-user-tag" ></i> T·∫•t c·∫£ ƒë·ªëi t∆∞·ª£ng
            </div>
            <div class="c-filter-item" onclick="switchSubjectView('staff', event)">
                <div class="mini-avatar" style="background:#4f46e5; color:#fff;"><i class="fa-solid fa-user-shield"></i></div>
                <span>Nh√¢n vi√™n</span>
                <i class="fa-solid fa-chevron-right" style="margin-left:auto; font-size:10px; opacity:0.5"></i>
            </div>
            <div class="c-filter-item" onclick="switchSubjectView('supplier', event)">
                <div class="mini-avatar" style="background:#f59e0b; color:#fff;"><i class="fa-solid fa-truck-field"></i></div>
                <span>Nh√† cung c·∫•p</span>
                <i class="fa-solid fa-chevron-right" style="margin-left:auto; font-size:10px; opacity:0.5"></i>
            </div>
            <div class="c-filter-item" onclick="switchSubjectView('customer', event)">
                <div class="mini-avatar" style="background:#10b981; color:#fff;"><i class="fa-solid fa-hospital-user"></i></div>
                <span>Kh√°ch h√†ng</span>
                <i class="fa-solid fa-chevron-right" style="margin-left:auto; font-size:10px; opacity:0.5"></i>
            </div>
        `;
    } else {
        // --- C·∫§P 2: DANH S√ÅCH CHI TI·∫æT ---
        let html = `<div class="c-filter-item" onclick="switchSubjectView('root', event)" style="color:#3b82f6; font-weight:700; border-bottom:1px solid #f1f5f9;"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</div>`;
        
        let dataList = [];
        let bgColor = '#10b981';

        // √âP BU·ªòC L·∫§Y T·ª™ WINDOW ƒê·ªÇ TR√ÅNH L·ªñI SCOPE MODULE
        if (currentSubjectView === 'staff') {
            dataList = window.allStaff || []; 
            bgColor = '#4f46e5';
            const validAdminLogo = (ADMIN_LOGO_URL && ADMIN_LOGO_URL.startsWith('http'));
            html += `
                <div class="c-filter-item" onclick="selectSubject('staff', 'admin', 'Admin H·ªá th·ªëng', '${validAdminLogo ? ADMIN_LOGO_URL : ''}')">
                    <div class="mini-avatar" style="background:#d35400; color:#fff;">AD</div>
                    <span>Admin H·ªá th·ªëng</span>
                </div>`;
        } else if (currentSubjectView === 'supplier') {
            dataList = window.allSuppliers || []; 
            bgColor = '#f59e0b';
        } else if (currentSubjectView === 'customer') {
            dataList = window.allCustomers || []; 
            bgColor = '#10b981';
        }

        // Ki·ªÉm tra n·∫øu danh s√°ch th·ª±c s·ª± tr·ªëng
        if (dataList.length === 0) {
            html += `<div style="padding:20px; text-align:center; color:#94a3b8; font-size:12px; font-style:italic;">Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã</div>`;
        } else {
            dataList.forEach(item => {
                const name = item.name || "Kh√¥ng t√™n";
                const pic = (currentSubjectView === 'staff') ? getAvatarDynamic(item.email, name, 'staff') : (item.img || item.image || "");
                const hasPic = (pic && pic.length > 10);
                
                // BI·∫æN QUAN TR·ªåNG: Staff l·ªçc theo Email, Kh√°ch/NCC l·ªçc theo T√™n
                const filterValue = (currentSubjectView === 'staff') ? (item.email || "").toLowerCase() : name.toLowerCase();

                html += `
                    <div class="c-filter-item" onclick="selectSubject('${currentSubjectView}', '${filterValue.replace(/'/g, "\\'")}', '${name.replace(/'/g, "\\'")}', '${hasPic ? pic : ''}')">
                        ${hasPic ? 
                            `<img src="${pic}" class="mini-avatar">` : 
                            `<div class="mini-avatar" style="background:${bgColor}; color:#fff;">${name.charAt(0).toUpperCase()}</div>`
                        }
                        <span>${name}</span>
                    </div>`;
            });
        }
        subjectBox.innerHTML = html;
    }
    
    if (typeof renderTimeFilterOptions === 'function') renderTimeFilterOptions();
};

window.selectTime = function(val, label) {
    filterState.timeRange = val;
    document.getElementById('btnTimeContent').innerHTML = val === '' 
        ? `<i class="fa-solid fa-clock" style="color:#94a3b8"></i> <span>T·∫•t c·∫£ khung gi·ªù</span>`
        : `<i class="fa-solid fa-clock" style="color:#3b82f6"></i> <span>${label}</span>`;
    
    document.getElementById('dropTimeOptions').classList.remove('show');
    reloadHistory();
};

window.currentSubjectView = 'root'; 
// --- BI·∫æN TO√ÄN C·ª§C ---


// ƒê·∫£m b·∫£o c√°c bi·∫øn n√†y ƒë∆∞·ª£c kh·ªüi t·∫°o m·∫£ng r·ªóng
window.allStaff = [];      
window.allCustomers = [];  
window.allSuppliers = []; 
window.customerMap = {}; 
window.supplierMap = {};
window.userMap = {};

window.switchSubjectView = function(view, e) {
    if(e) e.stopPropagation();
    currentSubjectView = view;
    window.updateFilterOptions();
};

window.selectSubject = function(type, val, label, pic) {
    filterState.subjectType = type;
    filterState.subjectValue = val;
    
    const btnContainer = document.getElementById('btnSubjectContent');
    const hasPic = (pic && pic.length > 10);

    if (type === 'all') {
        btnContainer.innerHTML = `<i class="fa-solid fa-users-viewfinder" style="color:#94a3b8"></i> <span>T·∫•t c·∫£ ƒë·ªëi t∆∞·ª£ng</span>`;
    } else {
        const bg = (type === 'staff') ? '#4f46e5' : (type === 'supplier' ? '#f59e0b' : '#10b981');
        const icon = (type === 'staff') ? 'fa-user-shield' : (type === 'supplier' ? 'fa-truck-field' : 'fa-hospital-user');
        
        if (hasPic) {
            btnContainer.innerHTML = `<img src="${pic}" style="width:24px; height:24px; border-radius:50%; object-fit:cover; border:1px solid #e2e8f0;"> <span>${label}</span>`;
        } else {
            btnContainer.innerHTML = `<div class="mini-avatar" style="width:24px; height:24px; border-radius:50%; background:${bg}; color:#fff; display:flex; align-items:center; justify-content:center; font-size:10px;"><i class="fa-solid ${icon}"></i></div> <span>${label}</span>`;
        }
    }

    currentSubjectView = 'root'; // Reset v·ªÅ root cho l·∫ßn m·ªü sau
    document.getElementById('dropSubjectOptions').classList.remove('show');
    reloadHistory();
};

// --- 3. H√ÄM CH·ªåN ITEM ---
window.selectFilter = function(type, val, label, pic) {
    filterState[type] = val;
    
    // X√°c ƒë·ªãnh ID n·ªôi dung n√∫t b·∫•m (btnCustContent / btnExecContent)
    let btnId = (type === 'customer') ? 'btnCustContent' : (type === 'executor' ? 'btnExecContent' : 'btnTimeContent');
    const btnContainer = document.getElementById(btnId);
    if (!btnContainer) return;

    const hasPic = (pic && pic.length > 10);

    if (val === '') {
        const icon = (type === 'customer') ? 'fa-user-tag' : (type === 'executor' ? 'fa-user-shield' : 'fa-clock');
        btnContainer.innerHTML = `<i class="fa-solid ${icon}" style="color:#94a3b8"></i> <span>${label}</span>`;
    } else if (hasPic) {
        // HI·ªÜN ·∫¢NH L√äN VI√äN THU·ªêC
        btnContainer.innerHTML = `
            <img src="${pic}" style="width:24px; height:24px; border-radius:50%; object-fit:cover; border:1px solid #e2e8f0;" 
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="mini-avatar" style="display:none; width:24px; height:24px; border-radius:50%; background:#10b981; color:#fff; align-items:center; justify-content:center; font-size:10px;">${label.charAt(0)}</div>
            <span>${label}</span>`;
    } else {
        // HI·ªÜN V√íNG TR√íN CH·ªÆ C√ÅI
        const bg = (type === 'customer') ? '#10b981' : '#4f46e5';
        btnContainer.innerHTML = `
            <div class="mini-avatar" style="width:24px; height:24px; border-radius:50%; background:${bg}; color:#fff; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:bold;">${label.charAt(0).toUpperCase()}</div>
            <span>${label}</span>`;
    }

    document.querySelectorAll('.c-filter-options').forEach(opt => opt.classList.remove('show'));
    reloadHistory();
};

window.clearFilters = function() {
    filterState = { subjectType: 'all', subjectValue: '', timeRange: '' };
    currentSubjectView = 'root';
    
    document.getElementById('btnSubjectContent').innerHTML = `<span>T·∫•t c·∫£ ƒë·ªëi t∆∞·ª£ng</span>`;
    document.getElementById('btnTimeContent').innerHTML = `<span>T·∫•t c·∫£ khung gi·ªù</span>`;

    reloadHistory();
    updateFilterOptions();
};

// G·ªçi h√†m updateFilterOptions trong onSnapshot c·ªßa logs
// T√¨m ƒëo·∫°n onSnapshot(doc(db, "warehouse_history_logs", STORE_ID)... v√† th√™m:
// updateFilterOptions();


// --- THAY TH·∫æ H√ÄM reloadHistory C≈® (C·∫≠p nh·∫≠t badge hi·ªÉn th·ªã b√™n ngo√†i) ---
// --- THAY TH·∫æ TO√ÄN B·ªò H√ÄM reloadHistory ---
// --- THAY TH·∫æ TO√ÄN B·ªò H√ÄM reloadHistory ---
function reloadHistory() {
    const container = document.getElementById('historyListContainer');
    if (!container) return;
    
    const historyData = getGroupedHistory();
    container.innerHTML = '';

    if (historyData.length === 0) {
        document.getElementById('historyRightPanel').innerHTML = `
            <div class="empty-state show">
                <i class="fa-solid fa-box-open"></i>
                <p>Ch∆∞a c√≥ giao d·ªãch n√†o ph√π h·ª£p</p>
            </div>`;
        return;
    }

    historyData.forEach(group => {
        const type = (group.type || '').toLowerCase();
        
        // 1. PH√ÇN LO·∫†I R√ï R√ÄNG (D√πng OR ƒë·ªÉ b·∫Øt h·∫øt c√°c tr∆∞·ªùng h·ª£p)
        const isXuat = (type === 'xuat' || type === 'export');
        const isChuyen = (type === 'chuyen' || type.includes('transfer'));
        const isKiemKe = (type === 'kiemke' || type.includes('check') || type.includes('audit'));
        // N·∫øu kh√¥ng ph·∫£i 3 lo·∫°i tr√™n th√¨ l√† Nh·∫≠p (bao g·ªìm 'nhap', 'import', ho·∫∑c string l·∫°)
        const isNhap = (!isXuat && !isChuyen && !isKiemKe); 

        // 2. C·∫§U H√åNH GIAO DI·ªÜN
        let icon = 'fa-download';
        let title = 'Nh·∫≠p kho';
        let iconColor = '#22c55e'; // Xanh l√°
        let iconBg = '#f0fdf4';
        
        if (isXuat) {
            icon = 'fa-upload';
            title = 'Xu·∫•t kho';
            iconColor = '#ef4444'; // ƒê·ªè
            iconBg = '#fef2f2';
        } else if (isChuyen) {
            icon = 'fa-right-left'; 
            title = 'Chuy·ªÉn kho';
            iconColor = '#3b82f6'; // Xanh d∆∞∆°ng
            iconBg = '#eff6ff';
        } else if (isKiemKe) {
            icon = 'fa-clipboard-check';
            title = 'Ki·ªÉm k√™ kho';
            iconColor = '#d97706'; // Cam ƒë·∫•t
            iconBg = '#fffbeb';
        }

        const timeRange = `${String(group.hour).padStart(2,'0')}:00 - ${String(group.hour+1).padStart(2,'0')}:00`;
        const isActive = group.id === selectedGroupId ? 'active' : '';

        // Badge Ph√≠/Gi·∫£m (Kh√¥ng hi·ªán cho Ki·ªÉm k√™)
        let badgeHtml = '';
        if (!isKiemKe) {
            if (group.grpNetAdjustment > 0) {
                badgeHtml = `<span style="font-size:10px; background:#fff7ed; color:#c2410c; padding:1px 6px; border-radius:4px; margin-left:5px;">+Ph√≠</span>`;
            } else if (group.grpNetAdjustment < 0) {
                badgeHtml = `<span style="font-size:10px; background:#f0fdf4; color:#15803d; padding:1px 6px; border-radius:4px; margin-left:5px;">-Gi·∫£m</span>`;
            }
        }

        // Hi·ªÉn th·ªã gi√° tr·ªã b√™n ph·∫£i (Ti·ªÅn ho·∫∑c S·ªë l∆∞·ª£ng)
        let valueDisplay = formatVND(group.grpTotalAmount);
        
        if (isKiemKe) {
            // Ki·ªÉm k√™: Hi·ªán s·ªë l·ªách
            let totalDiff = 0;
            group.itemsList.forEach(i => totalDiff += Number(i.qty));
            const sign = totalDiff > 0 ? '+' : '';
            const colorDiff = totalDiff > 0 ? '#16a34a' : (totalDiff < 0 ? '#dc2626' : '#64748b');
            valueDisplay = `<span style="color:${colorDiff}">${sign}${totalDiff} l·ªách</span>`;
        } else if (isChuyen) {
            // Chuy·ªÉn kho: Hi·ªán s·ªë m·∫∑t h√†ng
             valueDisplay = `${group.itemsList.length} m·∫∑t h√†ng`;
        }

        // T√™n hi·ªÉn th·ªã (N·∫øu ki·ªÉm k√™ th√¨ ghi l√† C√¢n b·∫±ng kho)
        const displayName = isKiemKe ? "C√¢n b·∫±ng kho" : group.supplier;

        const itemHtml = `
            <div class="history-item ${isActive}" data-id="${group.id}" onclick="viewDetail('${group.id}', this)">
                <div class="history-item-icon-box" style="background:${iconBg}; color:${iconColor}; width:35px; height:35px; display:flex; align-items:center; justify-content:center; border-radius:8px;">
                    <i class="fa-solid ${icon}"></i>
                </div>
                <div class="history-item-body">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:700; font-size:15px; color:#334155;">${title}</span>
                        <span style="font-size:11px; color:#94a3b8;">${group.dateStr}</span>
                    </div>
                    <div style="margin: 4px 0; font-size:13px; font-weight:600; color:#0056e0;">
                        ${isChuyen ? `ƒê·∫øn: ${displayName}` : displayName} ${badgeHtml}
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#64748b;">
                        <span><i class="fa-regular fa-clock"></i> ${timeRange}</span>
                        <span><b>${valueDisplay}</b></span>
                    </div>
                </div>
            </div>`;
        container.insertAdjacentHTML('beforeend', itemHtml);
    });

    // Auto click item ƒë·∫ßu ti√™n ho·∫∑c item ƒëang ch·ªçn
    if (!selectedGroupId && container.children.length > 0) {
        container.children[0].click();
    } else if (selectedGroupId) {
        const existEl = document.querySelector(`.history-item[data-id="${selectedGroupId}"]`);
        if (existEl) viewDetail(selectedGroupId, null); 
        else if (container.children.length > 0) container.children[0].click();
    }
}


// --- C·∫¨P NH·∫¨T VIEW DETAIL: CHU·∫®N UI (ƒê√É FIX L·ªñI DATA C≈® & L·ªÜCH C·ªòT) ---
window.viewDetail = function(groupId, el) {
    selectedGroupId = groupId;
    
    // 1. Active menu hi·ªáu ·ª©ng
    document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
    if (el) el.classList.add('active');
    else {
        const activeEl = document.querySelector(`.history-item[data-id="${groupId}"]`);
        if (activeEl) activeEl.classList.add('active');
    }
    
    // 2. L·∫•y d·ªØ li·ªáu
    const groups = getGroupedHistory();
    const data = groups.find(g => g.id === groupId);
    
    if (!data) {
        document.getElementById('historyRightPanel').innerHTML = `
            <div style="display:flex; height:100%; align-items:center; justify-content:center; flex-direction:column; color:#94a3b8;">
                <i class="fa-regular fa-folder-open" style="font-size:40px; margin-bottom:10px;"></i>
                <p>Ch·ªçn m·ªôt phi·∫øu ƒë·ªÉ xem chi ti·∫øt</p>
            </div>`;
        return;
    }

    // --- PH√ÇN LO·∫†I PHI·∫æU ---
    const type = (data.type || '').toLowerCase();
    const isXuat = (type === 'xuat' || type === 'export');
    const isNhap = (type === 'nhap' || type === 'import');
    const isChuyen = (type === 'chuyen' || type.includes('transfer'));
    const isKiemKe = (type === 'kiemke' || type.includes('check') || type.includes('stocktake'));
    
    // --- T√çNH TO√ÅN HEADER ---
    let totalQty = 0; 
    const uniqueSet = new Set();
    
    data.itemsList.forEach(item => {
        totalQty += Number(item.qty || 0);
        const uniqueKey = (item.sku || item.name || "unknown").toString().trim().toLowerCase();
        uniqueSet.add(uniqueKey);
    });

    const countLoaiHang = uniqueSet.size;

    // --- C·∫§U H√åNH GIAO DI·ªÜN THEO LO·∫†I PHI·∫æU ---
    let headerTitle = 'Phi·∫øu Nh·∫≠p Kho';
    let headerIcon = 'fa-download';
    let headerColor = '#22c55e'; // Green
    let headerBg = '#f0fdf4';
    let summaryHtml = '';
    let adjRow = '';

    const totalAdj = Number(data.grpNetAdjustment || 0);
    if (totalAdj > 0) {
        adjRow = `<div class="summary-box" style="color:#c2410c; border-color:#ffedd5; background:#fff7ed;">T·ªïng Ph√≠: <b>+${formatVND(totalAdj)}</b></div>`;
    } else if (totalAdj < 0) {
        adjRow = `<div class="summary-box" style="color:#15803d; border-color:#dcfce7; background:#f0fdf4;">T·ªïng Gi·∫£m: <b>-${formatVND(Math.abs(totalAdj))}</b></div>`;
    }

    if (isKiemKe) {
        headerTitle = 'Phi·∫øu Ki·ªÉm K√™ Kho';
        headerIcon = 'fa-clipboard-check';
        headerColor = '#6366f1';
        headerBg = '#eef2ff';
        summaryHtml = ''; // B·ªé TR·∫†NG TH√ÅI THEO Y√äU C·∫¶U
    } 
    else if (isXuat) {
        headerTitle = 'Phi·∫øu Xu·∫•t Kho';
        headerIcon = 'fa-upload';
        headerColor = '#ef4444'; // Red
        headerBg = '#fef2f2';
        summaryHtml = `
            <div class="summary-box" title="T·ªïng gi√° v·ªën">V·ªën: <b>${formatVND(data.grpSubTotal || 0)}</b></div>
            ${adjRow}
            <div class="summary-box" style="background:#fff7ed; border:1px solid #ffedd5; color:#c2410c;" title="T·ªïng ti·ªÅn kh√°ch ph·∫£i tr·∫£">
                Doanh thu: <b>${formatVND(data.grpTotalAmount || 0)}</b>
            </div>`;
    } 
    else if (isChuyen) {
        headerTitle = 'Phi·∫øu Chuy·ªÉn Kho';
        headerIcon = 'fa-right-left';
        headerColor = '#3b82f6'; // Blue
        headerBg = '#eff6ff';
        summaryHtml = `${adjRow}`; 
    } 
    else {
        // M·∫∑c ƒë·ªãnh Nh·∫≠p kho
        summaryHtml = `
            <div class="summary-box" style="background:#f0fdf4; border:1px solid #dcfce7; color:#15803d;">
                T·ªïng nh·∫≠p: <b>${formatVND(data.grpTotalAmount || 0)}</b>
            </div>`;
    }

    // --- HTML ƒê·ªêI T√ÅC (KI·ªÇM K√ä S·∫º R·ªñNG) ---
    let partnerHtml = '';
    if (isKiemKe) {
        // Ki·ªÉm k√™: Kh√¥ng hi·ªán th√¥ng tin ƒë·ªëi t√°c/kh√°ch h√†ng
        partnerHtml = ''; 
    } else if (isChuyen) {
        partnerHtml = `
            <div class="transfer-route-card">
                <div class="tr-node"><i class="fa-solid fa-warehouse tr-icon"></i><span class="tr-label">T·ª´ kho</span><span class="tr-name">Kho n√†y</span></div>
                <div class="tr-arrow"><i class="fa-solid fa-arrow-right-long"></i></div>
                <div class="tr-node"><i class="fa-solid fa-shop tr-icon"></i><span class="tr-label">ƒê·∫øn kho</span><span class="tr-name" title="${data.supplier}">${data.supplier}</span></div>
            </div>`;
    } else {
        const logId = data.customerId || "";
        const rawName = data.supplier || "Kh√°ch l·∫ª";
        const latest = customerMap[logId] || customerMap[rawName.toLowerCase()];
        let displayImg = data.customerImg || (latest ? latest.img : "");
        let isDeleted = (rawName !== 'Kh√°ch l·∫ª' && !latest && logId !== "");

        partnerHtml = `
            <div class="customer-card-new">
                ${displayImg ? 
                    `<img src="${displayImg}" class="cc-avatar-img">` : 
                    `<div class="cc-avatar-placeholder" style="background:${isDeleted ? '#94a3b8' : '#10b981'}">
                        ${isDeleted ? '<i class="fa-solid fa-user-slash"></i>' : rawName.charAt(0).toUpperCase()}
                    </div>`
                }
                <div class="cc-info">
                    <span class="cc-role">${isNhap ? 'NH√Ä CUNG C·∫§P' : 'KH√ÅCH H√ÄNG'}</span>
                    <span class="cc-name">${rawName} ${isDeleted ? '<small style="color:red;">(ƒê√£ x√≥a)</small>' : ''}</span>
                </div>
            </div>`;
    }
   

    // --- HTML NG∆Ø·ªúI TH·ª∞C THI ---
    const executorName = (data.user || "Nh√¢n vi√™n").trim();
    const executorEmail = (data.email || "").trim().toLowerCase();
    const myEmail = (localStorage.getItem('userEmail') || "").trim().toLowerCase();
    const ADMIN_LOGO_URL = localStorage.getItem('admin_logo_url'); 
    
    let executorPic = null;
    const isThisExecutorAdmin = (storeOwnerEmail !== "" && executorEmail === storeOwnerEmail) || 
                                executorEmail.includes('admin') || 
                                executorName.toLowerCase().includes('admin');

    if (isThisExecutorAdmin) executorPic = ADMIN_LOGO_URL;
    else {
        if (executorEmail === myEmail && myEmail !== "") executorPic = localStorage.getItem('userPicture');
        else executorPic = userMap[executorEmail] || userMap[executorName.toLowerCase()] || "";
    }

    let executorAvatarHtml = `<div class="ec-placeholder" style="background:${isThisExecutorAdmin ? '#d35400' : '#4f46e5'}; width:32px; height:32px; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px;">${executorName.charAt(0).toUpperCase()}</div>`;
    
    if (executorPic && executorPic.length > 10) { 
        executorAvatarHtml = `
            <img src="${executorPic}" class="ec-avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="ec-placeholder" style="display:none; background:#4f46e5; color:white; width:32px; height:32px; border-radius:50%; align-items:center; justify-content:center; font-weight:bold; font-size:14px;">${executorName.charAt(0).toUpperCase()}</div>`;
    }

    const executorHtml = `
        <div class="executor-card">
            ${executorAvatarHtml}
            <div class="ec-info"><span class="ec-label">Ng∆∞·ªùi th·ª±c thi</span><span class="ec-name" title="${executorEmail}">${executorName}</span></div>
        </div>`;

    // --- N√öT X√ìA ---
    const trashStyle = (typeof canEditHistory !== 'undefined' && canEditHistory)
        ? "color:#ef4444; background:#fff1f2; cursor:pointer; opacity:1;" 
        : "color:#cbd5e1; background:#f8fafc; cursor:not-allowed; opacity:0.5;";

    const actionIconsHtml = `
        <div style="margin-left:auto;">
            <i class="fa-regular fa-trash-can" 
            style="font-size:18px; padding:10px; border-radius:50%; transition:0.3s; ${trashStyle}"
            title="X√≥a phi·∫øu"
            onclick="${(typeof canEditHistory !== 'undefined' && canEditHistory) ? `window.confirmDeleteHistory('${data.id}')` : `Swal.fire('Th√¥ng b√°o','B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a!','info')`}">
            </i>
        </div>`;

    // --- RENDER DANH S√ÅCH S·∫¢N PH·∫®M ---
    const rowsHtml = data.itemsList.map(p => {
    const categoryBadge = (p.category && p.category !== '---') 
        ? `<span style="font-size:11px; background:#f1f5f9; color:#64748b; padding:2px 8px; border-radius:4px; border:1px solid #e2e8f0;">${p.category}</span>` 
        : `<span style="font-size:11px; color:#cbd5e1; font-style:italic;">---</span>`;

    let qtyColor = isNhap ? '#16a34a' : '#dc2626';
    let qtyBg = isNhap ? '#f0fdf4' : '#fef2f2';
    let qtySign = isNhap ? '+' : '-';
    if (isChuyen) { qtyColor = '#0369a1'; qtyBg = '#f0f9ff'; qtySign = '-'; }
    if (isKiemKe) { qtyColor = '#6366f1'; qtyBg = '#eef2ff'; qtySign = (Number(p.qty) > 0) ? '+' : ''; }

    const rowPrice = Number(p.price || 0);
    const rowQty = Number(p.qty || 0);
    const totalSalesPrice = Math.abs(rowPrice * rowQty);

    const hideMoneyStyle = (isChuyen || isKiemKe) ? 'display:none;' : '';
    const hideAdjStyle = (isChuyen || isKiemKe || isNhap) ? 'display:none;' : '';

    // L·∫§Y GHI CH√ö T·ª™ DATA
    const noteText = p.note && p.note.trim() !== "" ? p.note : "Kh√¥ng c√≥ ghi ch√∫ cho m·ª•c n√†y";

    return `
    <tr class="product-row" onclick="toggleProductNote(event, this)">
        <td style="width:50px; padding:8px 10px;">
            <div style="width:40px; height:40px; border-radius:6px; overflow:hidden; border:1px solid #e2e8f0;">
                <img src="${p.img}" onerror="this.src='${NO_IMAGE_URL}'" style="width:100%; height:100%; object-fit:contain;">
            </div>
        </td>
        <td style="padding:8px 10px;">
            <div style="font-weight:600; font-size:13px; color:#334155;">${p.name}</div>
            <div style="color:#94a3b8; font-family:monospace; font-size:11px;">${p.sku || '---'}</div>
        </td>
        <td style="text-align:center;">${categoryBadge}</td>
        <td style="text-align:right; ${hideMoneyStyle}">
            <div style="font-size:13px; font-weight:700;">${formatVND(rowPrice)}</div>
        </td>
        <td style="text-align:right; font-size:13px; font-weight:800; color:#0056e0; ${hideMoneyStyle}">${formatVND(totalSalesPrice)}</td>
        <td style="text-align:center; font-size:12px; color:#64748b;">
            ${p.oldStock} ‚Üí <b>${p.newStock}</b>
        </td>
        <td style="text-align:right;">
            <b style="font-size:13px; color:${qtyColor}; background:${qtyBg}; padding:2px 6px; border-radius:4px;">
                ${qtySign}${rowQty}
            </b>
        </td>
    </tr>
    <!-- D√íNG GHI CH√ö ·∫®N -->
    <tr class="note-row">
        <td colspan="8" style="padding:0; border:none;">
            <div class="note-wrapper">
                <div class="note-content-box">
                    <i class="fa-solid fa-comment-dots" style="color:#3498db"></i>
                    <span><b>Ghi ch√∫:</b> ${noteText}</span>
                </div>
            </div>
        </td>
    </tr>`;
}).join('');

    // --- FINAL RENDER ---
    document.getElementById('historyRightPanel').innerHTML = `
        <div class="detail-header-bar active">
            <div style="display:flex; align-items:center; gap:12px; flex:1;">
                 <div style="width:36px; height:36px; border-radius:8px; background:${headerBg}; color:${headerColor}; display:flex; align-items:center; justify-content:center; font-size:18px;">
                    <i class="fa-solid ${headerIcon}"></i>
                </div>
                <div>
                    <h3 style="margin:0; font-size:16px; color:#1e293b;">${headerTitle}</h3>
                    <small style="color:#64748b; font-size:11px;">${data.dateStr} l√∫c ${String(new Date(data.rawTimestamp).getHours()).padStart(2,'0')}:${String(new Date(data.rawTimestamp).getMinutes()).padStart(2,'0')}</small>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:15px;">
                ${executorHtml}
                ${actionIconsHtml}
            </div>
        </div>

        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 20px; background:#fff; border-bottom:1px solid #f1f5f9;">
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                <div class="summary-box">Lo·∫°i: <b>${countLoaiHang}</b></div>
                ${!isKiemKe ? `<div class="summary-box">T·ªïng SL: <b>${totalQty}</b></div>` : ''}
                ${summaryHtml}
            </div>
            <div style="flex-shrink:0;">
                ${partnerHtml}
            </div>
        </div>

        <div style="flex:1; overflow:hidden; padding:0 20px 20px 20px; background:#fff;">
            <div style="height:100%; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; margin-top:5px;">
                <table class="product-table" style="width:100%; border-collapse:collapse;">
                    <thead style="position:sticky; top:0; z-index:5; background:#f8fafc; font-size:12px; color:#64748b; text-transform:uppercase;">
                        <tr>
                            <th style="padding:10px; width:50px;">·∫¢nh</th>
                            <th style="padding:10px;">S·∫£n ph·∫©m / SKU</th> 
                            <th style="text-align:center; padding:10px;">Danh m·ª•c</th> 
                            
                            <!-- Hi·ªÉn th·ªã "Gi√° nh·∫≠p" n·∫øu l√† phi·∫øu nh·∫≠p, ng∆∞·ª£c l·∫°i hi·ªán "Gi√° v·ªën & B√°n" -->
                            <th style="text-align:right; padding:10px; ${ (isChuyen || isKiemKe) ? 'display:none;' : ''}">
                                ${isNhap ? 'Gi√° nh·∫≠p' : 'Gi√° v·ªën & B√°n'}
                            </th>
                            
                            <th style="text-align:right; padding:10px; ${ (isChuyen || isKiemKe) ? 'display:none;' : ''}">Th√†nh ti·ªÅn</th>
                            
                            <!-- ·∫®N c·ªôt Ph√≠/Gi·∫£m n·∫øu l√† Nh·∫≠p kho, Chuy·ªÉn kho ho·∫∑c Ki·ªÉm k√™ -->
                            <th style="text-align:right; padding:10px; ${ (isChuyen || isKiemKe || isNhap) ? 'display:none;' : ''}">Ph√≠/Gi·∫£m</th>
                            
                            <th style="text-align:center; padding:10px;">T·ªìn kho</th>
                            <th style="text-align:right; padding:10px;">Bi·∫øn ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
            </div>
        </div>`;
};


// Gi·∫£ s·ª≠ ƒë√¢y l√† ƒëo·∫°n code trong h√†m render c·ªßa b·∫°n
function renderLogs(data) {
    const container = document.getElementById('logContainer');
    container.innerHTML = data.map(log => {
        // Ki·ªÉm tra n·∫øu c√≥ ghi ch√∫ th√¨ m·ªõi hi·ªÉn th·ªã icon ho·∫∑c chu·∫©n b·ªã n·ªôi dung
        const hasNote = log.note && log.note.trim() !== "";
        const noteContent = hasNote ? log.note : "Kh√¥ng c√≥ ghi ch√∫";

        return `
            <div class="log-row" onclick="toggleLogNote(event, this)">
                <div class="main-info">
                    <div class="col-img">
                        <img src="${log.img || NO_IMAGE_URL}" class="p-img">
                    </div>
                    <div class="col-product">
                        <div class="p-name">${log.name}</div>
                        <div class="p-sku">${log.sku}</div>
                    </div>
                    <div class="col-cat">
                        <span class="cat-badge">${log.category || 'N∆∞·ªõc'}</span>
                    </div>
                    <div class="col-stock">
                        ${log.oldStock} ‚Üí ${log.newStock}
                    </div>
                    <div class="col-change">
                        <span class="change-badge ${log.qty >= 0 ? 'pos' : 'neg'}">
                            ${log.qty > 0 ? '+' : ''}${log.qty}
                        </span>
                    </div>
                </div>
                
                <!-- PH·∫¶N GHI CH√ö ·∫®N -->
                <div class="note-detail">
                    <div class="note-inner">
                        <i class="fa-solid fa-pen-to-square"></i>
                        <span><b>Ghi ch√∫:</b> ${noteContent}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

    // ============================================================
    // 8. CH·ª®C NƒÇNG X√ìA
    // ============================================================
// --- C·∫¨P NH·∫¨T H√ÄM X√ìA Vƒ®NH VI·ªÑN ---
window.confirmDeleteHistory = function(groupId) {
    if (!canEditHistory) {
        Swal.fire('Th√¥ng b√°o', 'Quy·ªÅn x√≥a c·ªßa b·∫°n ƒë√£ b·ªã thu h·ªìi!', 'warning');
        return;
    }

    Swal.fire({
        title: 'X√≥a vƒ©nh vi·ªÖn?',
        text: "D·ªØ li·ªáu giao d·ªãch n√†y s·∫Ω b·ªã x√≥a ho√†n to√†n kh·ªèi h·ªá th·ªëng!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'ƒê·ªìng √Ω x√≥a',
        cancelButtonText: 'H·ªßy'
    }).then((result) => {
        if (result.isConfirmed) {
            const groups = getGroupedHistory();
            const data = groups.find(g => g.id === groupId);
            if (data) executeDeleteHistory(data);
        }
    });
};



// --- H√ÄM TH·ª∞C THI X√ìA (H·ªñ TR·ª¢ C·∫¢ C≈® V√Ä M·ªöI) ---
async function executeDeleteHistory(groupData) {
    // Hi·ªÉn th·ªã loading
    Swal.fire({
        title: 'ƒêang x√≥a...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const batch = writeBatch(db); // D√πng batch ƒë·ªÉ x√≥a nhanh h∆°n (cho log m·ªõi)
        let oldLogsToRemove = [];
        let hasNewLogs = false;

        // 1. Ph√¢n lo·∫°i c√°c item c·∫ßn x√≥a
        groupData.itemsList.forEach(item => {
            if (item.source === 'old') {
                // N·∫øu l√† log c≈© -> gom l·∫°i ƒë·ªÉ d√πng arrayRemove
                // C·∫ßn t√°i t·∫°o l·∫°i object y h·ªát l√∫c l∆∞u m·ªõi x√≥a ƒë∆∞·ª£c (kh√° r·ªßi ro n·∫øu data l·ªách)
                // C√°ch an to√†n nh·∫•t cho log c≈©: L·ªçc m·∫£ng c≈© v√† update l·∫°i ƒë√® l√™n.
                oldLogsToRemove.push(item.exactTime);
            } else {
                // N·∫øu l√† log m·ªõi -> X√≥a document
                // item.source l√† t√™n collection (vd: 'import_log')
                // item.id l√† ID document
                if (item.id && item.source) {
                    const docRef = doc(db, "warehouse_history_logs", currentStoreId, item.source, item.id);
                    batch.delete(docRef);
                    hasNewLogs = true;
                }
            }
        });

        const promises = [];

        // 2. Th·ª±c thi x√≥a LOG M·ªöI (n·∫øu c√≥)
        if (hasNewLogs) {
            promises.push(batch.commit());
        }

        // 3. Th·ª±c thi x√≥a LOG C≈® (n·∫øu c√≥)
        if (oldLogsToRemove.length > 0) {
            // L·∫•y d·ªØ li·ªáu c≈© hi·ªán t·∫°i
            const docRef = doc(db, "warehouse_history_logs", currentStoreId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const currentLogs = docSnap.data().logs || [];
                // L·ªçc b·ªè nh·ªØng log c√≥ timestamp tr√πng v·ªõi danh s√°ch c·∫ßn x√≥a
                const updatedLogs = currentLogs.filter(log => !oldLogsToRemove.includes(log.timestamp));
                
                promises.push(updateDoc(docRef, { logs: updatedLogs }));
            }
        }

        // Ch·∫°y t·∫•t c·∫£ song song
        await Promise.all(promises);
        
        Swal.fire({ title: "ƒê√£ x√≥a!", icon: "success", timer: 1500, showConfirmButton: false });
        selectedGroupId = null;

    } catch (error) {
        console.error("L·ªói x√≥a l·ªãch s·ª≠:", error);
        Swal.fire("L·ªói!", "Kh√¥ng th·ªÉ x√≥a giao d·ªãch: " + error.message, "error");
    }
}

    // ============================================================
    // 9. UTILS & INIT
    // ============================================================
    (function init() {
        initRealTimeData();
        renderYears();
        renderMonths();
        
        const nameEl = document.querySelector('.google-account-pill .user-name');
        const avatarEl = document.querySelector('.google-account-pill .user-avatar');
        if (nameEl) nameEl.innerText = localStorage.getItem('userName') || 'Ng∆∞·ªùi d√πng';
        if (avatarEl) {
            const pic = localStorage.getItem('userPicture');
            if(pic) avatarEl.src = pic;
        }
        setupDropdowns();
    })();
// Th√™m ƒëo·∫°n n√†y v√†o cu·ªëi h√†m init() ho·∫∑c ch·∫°y ngay khi load trang


    function setupDropdowns() {
        const drops = ['yearDropdown', 'monthDropdown', 'typeWrapper'];
        drops.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.onclick = (e) => {
                    e.stopPropagation();
                    drops.forEach(otherId => { if(otherId !== id) document.getElementById(otherId).classList.remove('active'); });
                    el.classList.toggle('active');
                }
            }
        });
        document.addEventListener('click', () => {
            drops.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('active');
            });
        });
        
        document.querySelectorAll('#typeOptions .c-option-item').forEach(opt => {
            opt.onclick = function(e) {
                e.stopPropagation();
                document.querySelectorAll('#typeOptions .c-option-item').forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');
                document.getElementById('typeDisplay').innerText = this.innerText;
                currentType = this.getAttribute('data-value');
                document.getElementById('typeWrapper').classList.remove('active');
                reloadHistory();
            }
        });
    }

    function renderYears() {
        const listYear = document.getElementById('listYear');
        const displayYear = document.getElementById('displayYear');
        if (!listYear) return;
        
        listYear.innerHTML = '';
        const currentYear = new Date().getFullYear();
        for (let y = currentYear; y >= currentYear - 5; y--) {
            const item = document.createElement('div');
            item.className = `c-option-item ${y === selectedYear ? 'selected' : ''}`;
            item.innerText = y;
            item.onclick = (e) => { 
                e.stopPropagation(); selectedYear = y; displayYear.innerText = y;
                document.getElementById('yearDropdown').classList.remove('active');
                renderMonths(); reloadHistory();
            };
            listYear.appendChild(item);
        }
        displayYear.innerText = selectedYear;
    }

    function renderMonths() {
        const listMonth = document.getElementById('listMonth');
        const displayMonth = document.getElementById('displayMonth');
        if (!listMonth) return;

        listMonth.innerHTML = '';
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;
        let maxMonth = (selectedYear === currentYear) ? currentMonth : 12;
        
        for (let m = 1; m <= maxMonth; m++) {
            const item = document.createElement('div');
            item.className = `c-option-item ${m === selectedMonth ? 'selected' : ''}`;
            const mText = m < 10 ? '0' + m : m;
            item.innerText = mText;
            item.onclick = (e) => { 
                e.stopPropagation(); selectedMonth = m; displayMonth.innerText = mText;
                document.getElementById('monthDropdown').classList.remove('active'); 
                reloadHistory();
            };
            listMonth.appendChild(item);
        }
        displayMonth.innerText = selectedMonth < 10 ? '0' + selectedMonth : selectedMonth;
    }


    window.toggleMenu = function(id) {
        const element = document.getElementById(id);
        if (element) element.classList.toggle('active');
    };


    // --- 1. H√ÄM TOGGLE DROPDOWN ---
window.toggleHistoryDropdown = function(e) {
    if(e) e.stopPropagation();
    const drop = document.getElementById('historyDropdown');
    const isShowing = drop.classList.contains('show');
    closeAllDropdowns();
    if (!isShowing) drop.classList.add('show');
};

// --- 2. H√ÄM ƒê√ìNG T·∫§T C·∫¢ DROPDOWN (C·∫≠p nh·∫≠t theo y√™u c·∫ßu c·ªßa b·∫°n) ---
window.closeAllDropdowns = function() {
    document.querySelectorAll('.dropdown-content').forEach(c => c.classList.remove('show'));
    document.querySelectorAll('.custom-select-container').forEach(c => c.classList.remove('show'));
    const historyDrop = document.getElementById('historyDropdown');
    if(historyDrop) historyDrop.classList.remove('show');
    
    // ƒê√≥ng c√°c dropdown th√°ng/nƒÉm/lo·∫°i c≈©
    document.getElementById('monthDropdown')?.classList.remove('active');
    document.getElementById('yearDropdown')?.classList.remove('active');
    document.getElementById('typeWrapper')?.classList.remove('active');
};

// --- 3. EVENT LISTENER CLICK TO√ÄN C·ª§C ---
window.addEventListener('click', function(e) {
    // Logic c·ªßa b·∫°n
    if (!e.target.closest('.history-period-container') && 
        !e.target.closest('.custom-date-wrapper') &&
        !e.target.closest('.custom-type-wrapper') &&
        !e.target.closest('#quickCategoryPopup')) {
        closeAllDropdowns();
    }
    
    const quickPopup = document.getElementById('quickCategoryPopup');
    if (quickPopup && quickPopup.style.display === 'block' && !quickPopup.contains(e.target) && !e.target.closest('.badge')) {
        quickPopup.style.display = 'none';
    }
});

// --- 4. H√ÄM T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T KHO·∫¢NG TH·ªúI GIAN T·ª™ LOGS ---
function updateExistencePeriods() {
    const listEl = document.getElementById('historyList');
    if (!listEl || logs.length === 0) return;

    // Nh√≥m logs theo Th√°ng/NƒÉm
    const periods = {};
    logs.forEach(log => {
        const d = new Date(log.timestamp);
        const m = d.getMonth() + 1;
        const y = d.getFullYear();
        const key = `${m < 10 ? '0' + m : m}/${y}`;
        periods[key] = (periods[key] || 0) + 1;
    });

    // S·∫Øp x·∫øp th·ªùi gian m·ªõi nh·∫•t l√™n ƒë·∫ßu
    const sortedKeys = Object.keys(periods).sort((a, b) => {
        const [m1, y1] = a.split('/').map(Number);
        const [m2, y2] = b.split('/').map(Number);
        return y2 !== y1 ? y2 - y1 : m2 - m1;
    });

    listEl.innerHTML = sortedKeys.map(key => {
        const [m, y] = key.split('/');
        return `
            <li class="history-list-item" onclick="selectPeriod('${m}', '${y}')">
                <div class="time-info">
                    <span class="time-title">${key}</span>
                    <span class="item-count">T·ªïng s·ªë m·ª•c: ${periods[key]} m·ª•c</span>
                </div>
                <i class="fa-solid fa-arrow-right"></i>
            </li>
        `;
    }).join('');
}

// --- 5. H√ÄM KHI CLICK V√ÄO M·ªòT KHO·∫¢NG TH·ªúI GIAN ---
window.selectPeriod = function(m, y) {
    // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
    selectedMonth = parseInt(m);
    selectedYear = parseInt(y);

    // C·∫≠p nh·∫≠t UI hi·ªÉn th·ªã ·ªü date-wrapper
    document.getElementById('displayMonth').innerText = m;
    document.getElementById('displayYear').innerText = y;

    // ƒê√≥ng dropdown v√† reload d·ªØ li·ªáu
    closeAllDropdowns();
    reloadHistory();
    
    // ƒê·ªìng b·ªô l·∫°i c√°c item "selected" trong dropdown th√°ng/nƒÉm g·ªëc
    renderMonths();
    renderYears();
};

// --- 6. G·ªåI C·∫¨P NH·∫¨T KHI C√ì D·ªÆ LI·ªÜU M·ªöI ---
// B·∫°n h√£y t√¨m h√†m onSnapshot(doc(db, "warehouse_history_logs", STORE_ID)...) 
// v√† th√™m d√≤ng updateExistencePeriods() v√†o cu·ªëi n√≥.


</script>

    </body>
    </html>