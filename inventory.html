<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Nhập Xuất Tồn - Firebase Advanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/sidebar.css">
    <style>
        /* 1. Global & Layout */
        * { box-sizing: border-box; font-family: 'Baloo 2', cursive; }
        body { overflow: hidden; background: #eef2f7; margin: 0; min-height: 100vh; width: 100vw; display: flex; user-select: none; position: relative; }
        
        body::after { content: ""; position: fixed; width: 150vmax; height: 150vmax; top: -25%; left: -25%; z-index: -1; background-image: radial-gradient(circle at 20% 30%, #d0bcff 0%, transparent 40%), radial-gradient(circle at 80% 70%, #a1c4fd 0%, transparent 40%), radial-gradient(circle at 50% 50%, #c2e9fb 0%, transparent 50%); filter: blur(80px); animation: waveMovement 15s linear infinite; }
        @keyframes waveMovement { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .table-view { display: flex; width: 100%; min-height: 100vh; padding: 20px; gap: 10px; }
        .main-content { 
            flex-grow: 1; border: 3px solid #ffffff; box-shadow: -5px 5px 1px #b5b5ec; 
            background-color: #F8FAFC; height: calc(100vh - 40px); overflow-y: auto; 
            overflow-x: hidden; position: relative; border-radius: 15px; padding: 15px;
            scrollbar-width: none;
        }
        .main-content::-webkit-scrollbar { display: none; }

        /* 2. Stats Cards */
        .stats-container { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 16px; border: 1px solid #f0f0f0; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .stat-label { color: #64748b; font-size: 14px; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 28px; font-weight: 800; color: #1e293b; }

        /* 3. Toolbar & Header */
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .toolbar { display: flex; gap: 12px; align-items: center; }

        .custom-date-picker {
            display: flex; align-items: center; background: #fff; border: 1.5px solid #e2e8f0;
            border-radius: 12px; padding: 6px 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: all 0.3s;
        }
        .date-input-small, .date-input-year { border: none; outline: none; text-align: center; font-weight: 800; color: #1e293b; font-size: 16px; background: transparent; }
        .date-input-small { width: 32px; } .date-input-year { width: 55px; }
        .custom-date-picker span { color: #cbd5e1; margin: 0 4px; font-weight: bold; }

        .custom-dropdown { position: relative; width: 280px; }
        .dropdown-header {
            background: #fff; border: 1.5px solid #e2e8f0; padding: 11px 16px; border-radius: 12px;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .dropdown-header span { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 14px; white-space: nowrap; }
        .dropdown-list {
            position: absolute; top: calc(100% + 8px); left: 0; width: 100%;
            background: #fff; border: 1px solid #e2e8f0; border-radius: 14px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.1); list-style: none; padding: 8px; margin: 0;
            display: none; z-index: 1000; max-height: 280px; overflow-y: auto;
        }
        .dropdown-list.show { display: block; animation: slideUp 0.2s ease; }
        .dropdown-item { padding: 12px 14px; border-radius: 10px; color: #334155; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .dropdown-item:hover { background: #eff6ff; color: #2563eb; }

     

        .product-info { display: flex; align-items: center; gap: 16px; }
        .product-img { width: 44px; height: 44px; border-radius: 8px; object-fit: cover; background: #f8fafc; border: 1px solid #f1f5f9; }
        .product-name { display: block; font-weight: 700; color: #1e293b; line-height: 1.2; }
        .product-sku { display: block; font-size: 12px; color: #94a3b8; }
        .text-bold { font-weight: 700; color: #1e293b; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loading Spinner */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        /* --- HIGHLIGHT CỘT ĐẶC BIỆT --- */
/* --- 4. TABLE STYLES (CÂN ĐỐI & CĂN CHỈNH) --- */
        .inventory-table { width: 100%; border-collapse: separate; border-spacing: 0px 10px; margin-top: 10px; table-layout: fixed; /* Cố định layout để chia cột chuẩn */ }
        
        /* Mặc định tất cả căn GIỮA */
        .inventory-table th, 
        .inventory-table td { 
            text-align: center; 
            vertical-align: middle; 
            padding: 12px 5px; 
            font-size: 15px;
            color: #334155;
            border: none;
            overflow: hidden; text-overflow: ellipsis; /* Tránh vỡ khung */
        }

        /* RIÊNG Cột đầu tiên (Sản phẩm): Căn TRÁI */
        .inventory-table th:first-child,
        .inventory-table td:first-child {
            text-align: left;
            padding-left: 15px;
            border-top-left-radius: 14px; 
            border-bottom-left-radius: 14px;
        }

        .inventory-table td:last-child { border-top-right-radius: 14px; border-bottom-right-radius: 14px; }

        /* Style Tiêu đề */
        .inventory-table th {
            color: #94a3b8; font-size: 13px; font-weight: 700; text-transform: uppercase; white-space: nowrap;
        }
        
        /* Hiệu ứng hover */
        .inventory-table tbody tr { background: #fff; transition: 0.3s ease;outline: 2px solid white; }
        /* --- SỬA LỖI HIỂN THỊ ẢNH & DÒNG --- */

/* 1. Tắt hiệu ứng phóng to dòng (Nguyên nhân gây lỗi border chồng lên nhau) */
.inventory-table tbody tr:hover { 
    transform: none !important; 
    box-shadow: -2px 5px 0 0 #ececec; 
    border-radius: 15px;
    outline: 2px solid rgb(224, 224, 224);
    background-color: #f8f9fc !important; /* Chỉ đổi màu nền nhẹ nhàng */
    z-index: auto;
}




        /* Cụm Sản phẩm (Ảnh + Tên) */
        .product-info { 
            display: flex; 
            align-items: center; 
            justify-content: flex-start; /* Căn trái flexbox */
            gap: 12px; 
        }
        
        .product-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #f8fafc; border: 1px solid #f1f5f9; flex-shrink: 0; transition: 0.2s ease-in-out }
        .product-img:hover {transform:translateY(-2.5px) ; box-shadow: 0 3px 0 1px #cecece;}
        .product-name { display: block; font-weight: 700; color: #1e293b; line-height: 1.2; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;}
        .product-sku { display: block; font-size: 12px; color: #94a3b8; }
        .text-bold { font-weight: 700; color: #1e293b; }

        /* --- HIGHLIGHT CỘT (CĂN GIỮA) --- */
        .highlight-dau {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: 700;
            border-right: 2px dashed #cbd5e1;
        }

        .highlight-cuoi {
            background-color: #eff6ff;
            color: #1d4ed8; /* Xanh đậm hơn chút cho rõ */
            font-weight: 800;
            border-left: 2px solid #bfdbfe;
            border-right: 2px solid #bfdbfe;
            font-size: 16px;
        }

        



/* --- CSS HIỆU ỨNG KHỐI LIỀN MẠCH --- */
.clickable-total { cursor: pointer; transition: background-color 0.2s; }
.clickable-total:hover { background-color: #e2e8f0; }

/* Style cơ bản cho ô Active */
.formula-active {
    background-color: #dbeafe !important;
    color: #1e3a8a !important;
    font-weight: 800 !important;
    border-top: 2px solid #3b82f6 !important;
    border-bottom: 2px solid #3b82f6 !important;
    border-radius: 0 !important;
}

/* 1. Ô ĐẦU TIÊN của khối (Vốn Nhập - Vị trí thứ 6 sau khi đảo) */
td.formula-active:nth-child(6) {
    border-left: 3px solid #3b82f6 !important;
    border-top-left-radius: 8px !important;
    border-bottom-left-radius: 8px !important;
}

/* 2. Ô CUỐI CÙNG của khối (Thành Tiền - Vị trí thứ 8) */
td.formula-active:nth-child(8) {
    border-right: 3px solid #3b82f6 !important;
    border-top-right-radius: 8px !important;
    border-bottom-right-radius: 8px !important;
}




    </style>
</head>
<body>

<!-- LOADING VỚI THANH TIẾN ĐỘ -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="width: 300px; margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span id="loading-text" style="font-weight: 600; color: #475569; font-size: 14px;">Đang kết nối...</span>
            <span id="loading-percent" style="font-weight: 700; color: #3b82f6; font-size: 14px;">0%</span>
        </div>
        <div style="width: 100%; background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden;">
            <div id="progress-bar-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); transition: width 0.3s ease;"></div>
        </div>
    </div>
</div>

    <div class="table-view">
        <div class="sidebar" id="sidebar-container"></div>

        <div class="main-content">
            <div class="header-flex">
                <h1 style="font-size: 22px; margin: 0;">Báo cáo hàng tồn kho</h1>

                <div class="toolbar">
                    <div class="custom-date-picker">
                        <input type="text" id="inp-day" placeholder="DD" maxlength="2" class="date-input-small">
                        <span>/</span>
                        <input type="text" id="inp-month" placeholder="MM" maxlength="2" class="date-input-small">
                        <span>/</span>
                        <input type="text" id="inp-year" placeholder="YYYY" maxlength="4" class="date-input-year">
                    </div>

                    <div class="custom-dropdown" id="period-dropdown">
                        <div class="dropdown-header" onclick="toggleDropdown()">
                            <span id="selected-period-text">
                                <i class="fas fa-history"></i> Khoảng thời gian tồn tại
                            </span>
                            <i class="fas fa-chevron-down arrow-icon"></i>
                        </div>
                        <ul class="dropdown-list" id="period-list"></ul>
                    </div>
                </div>
            </div>

            <!-- STATS CONTAINER CÓ CHỐT NGÀY -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Tổng loại sản phẩm</div>
                    <div class="stat-value" id="total-types">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Tổng lượng tồn kho</div>
                    <div style="display: flex; align-items: center; gap: 25px;">
                        <!-- Số hiện tại -->
                        <div>
                            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; font-weight: 700;">Thực tế (Nay)</div>
                            <div class="stat-value" id="total-quantity-current" style="font-size: 28px;">0</div>
                        </div>
                        <!-- Số quá khứ (Sẽ hiện khi chọn ngày cũ) -->
                        <div id="history-qty-box" style="display: none; border-left: 2px solid #e2e8f0; padding-left: 25px;">
                            <div id="history-date-label" style="font-size: 11px; color: #3b82f6; text-transform: uppercase; font-weight: 700;">Chốt ngày ...</div>
                            <div class="stat-value" id="total-quantity-history" style="font-size: 28px; color: #64748b;">0</div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Giá trị kho (Thành tiền)</div>
                    <div class="stat-value" id="total-value-report" style="color: #0056e0;">0đ</div>
                </div>
            </div>

            <div style="margin-bottom: 20px; position: relative; width: 320px;">
                <i class="fas fa-search" style="position: absolute; left: 14px; top: 15px; color: #94a3b8;"></i>
                <input type="text" id="searchInput" placeholder="Tìm tên hoặc SKU..." onkeyup="filterTable()" 
                       style="width: 100%; padding: 12px 15px 12px 40px; border-radius: 12px; border: 1.5px solid #e2e8f0; outline: none;">
            </div>

                           <table class="inventory-table">
                                <thead>
                                    <tr>
                                        <th style="width: 22%;">Sản phẩm / SKU</th>
                                        
                                        <th style="width: 8%;" class="highlight-dau">Tồn Đầu</th>
                                        
                                        <th style="width: 7%;">Nhập</th>
                                        
                                        <th style="width: 7%;">Xuất</th> <!-- Chuyển Xuất về đây -->
                                        
                                        <th style="width: 11%;">Vốn Nhập</th> <!-- Đây là Đơn giá -->
                                        
                                        <th style="width: 13%; color: #16a34a;">Tổng Vốn Nhập</th> <!-- Cột Tổng tiền nhập -->
                                        
                                        <th style="width: 9%;" class="highlight-cuoi">Tồn Cuối</th>
                                        
                                        <th style="width: 17%;">Thành Tiền</th>
                                    </tr>
                                </thead>
                                <tbody id="product-list-body"></tbody>
                            </table>
        </div>
    </div>


<script type="module">
    import { db } from "../../firebase-config.js";
    import { 
        collection, onSnapshot, query, orderBy, limit, 
        where, getDocs, writeBatch // <-- Thêm 3 cái này vào cuối
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // --- 1. CẤU HÌNH & BIẾN ---
    const currentStoreId = localStorage.getItem('current_store_id');
    let allProducts = [];
    
    // Cache lưu trữ Logs
    let cachedImports = new Map();
    let cachedExports = new Map();
    
    // Index gom nhóm (Để tính toán nhanh)
    let importsByPid = {}; 
    let exportsByPid = {};
    let availableDates = new Set(); // Lưu lịch sử ngày

    let displayList = []; // Danh sách sản phẩm ĐÃ LỌC cần hiển thị
    let currentRenderIndex = 0; // Đang vẽ đến dòng bao nhiêu
    const BATCH_SIZE = 25; // Số dòng tải mỗi lần

    let isSwapped = false; // Trạng thái đảo cột
    const today = new Date();

    // --- 2. KHỞI TẠO NGÀY ---
    document.getElementById('inp-day').value = String(today.getDate()).padStart(2, '0');
    document.getElementById('inp-month').value = String(today.getMonth() + 1).padStart(2, '0');
    document.getElementById('inp-year').value = today.getFullYear();

    // Load Sidebar
    function loadSidebar() {
        const sidebarContainer = document.getElementById('sidebar-container');
        if (!sidebarContainer) return;
        fetch('/Warehouse-Management/Side-Bar.html')
            .then(res => res.text())
            .then(html => {
                sidebarContainer.innerHTML = html;
                const scripts = sidebarContainer.querySelectorAll("script");
                scripts.forEach(s => {
                    const ns = document.createElement("script");
                    Array.from(s.attributes).forEach(attr => ns.setAttribute(attr.name, attr.value));
                    ns.textContent = s.textContent;
                    s.parentNode.replaceChild(ns, s);
                });
            });
    }

    // --- 3. UI PROGRESS BAR ---
    function updateProgress(percent, text) {
        const bar = document.getElementById('progress-bar-fill');
        const txt = document.getElementById('loading-text');
        const num = document.getElementById('loading-percent');
        const overlay = document.getElementById('loading-overlay');

        if(overlay.style.display === 'none') overlay.style.display = 'flex';
        
        requestAnimationFrame(() => {
            bar.style.width = percent + '%';
            if(text) txt.innerText = text;
            num.innerText = percent + '%';
        });

        if (percent >= 100) {
            setTimeout(() => { overlay.style.display = 'none'; bar.style.width = '0%'; }, 500);
        }
    }

    // --- 4. TẢI DỮ LIỆU TỐI ƯU (GỘP CHUNG 1 LẦN TẢI) ---
    // --- CẬP NHẬT: TẢI DỮ LIỆU (BỎ QUA DỮ LIỆU CŨ HƠN 9 THÁNG) ---
    function loadLogsAndCalendar() {
        if (!currentStoreId) return;
        if (cachedImports.size === 0) updateProgress(10, "Đang kết nối máy chủ...");
        
        // 1. Tính mốc thời gian 9 tháng trước
        const cutoffDate = new Date();
        cutoffDate.setMonth(cutoffDate.getMonth() - 9);
        const cutoffTs = cutoffDate.getTime(); // Đổi ra mili-giây để so sánh

        const LOG_LIMIT = 3000;
        const qImport = query(collection(db, "warehouse_history_logs", currentStoreId, "import_log"), orderBy("timestamp", "desc"), limit(LOG_LIMIT));
        const qExport = query(collection(db, "warehouse_history_logs", currentStoreId, "export_log"), orderBy("timestamp", "desc"), limit(LOG_LIMIT));

        let loadedImport = false;
        let loadedExport = false;

        const handleSnapshot = (snapshot, cacheMap, type) => {
            snapshot.docChanges().forEach(change => {
                const data = change.doc.data();
                
                // --- 2. LẤY THỜI GIAN CỦA LOG ---
                let ts = 0;
                if (data.timestamp) {
                    if (data.timestamp.seconds) ts = data.timestamp.seconds * 1000;
                    else if (typeof data.timestamp.toDate === 'function') ts = data.timestamp.toDate().getTime();
                    else ts = new Date(data.timestamp).getTime();
                }

                // --- 3. KIỂM TRA ĐIỀU KIỆN 9 THÁNG ---
                // Nếu thời gian log nhỏ hơn mốc 9 tháng -> BỎ QUA NGAY
                if (ts < cutoffTs) {
                    return; 
                }

                if (change.type === "added" || change.type === "modified") {
                    cacheMap.set(change.doc.id, data);
                    extractDateFromLog(data);
                }
                if (change.type === "removed") {
                    cacheMap.delete(change.doc.id);
                }
            });
            
            if (type === 'import') loadedImport = true;
            if (type === 'export') loadedExport = true;

            if (loadedImport && loadedExport) {
                rebuildIndexAndRender();
                renderHistoryDropdown();
                updateProgress(100, "Hoàn tất!");
            } else {
                updateProgress(60, "Đang xử lý dữ liệu...");
            }
        };

        if (!window.listenersActive) {
            onSnapshot(qImport, (snap) => handleSnapshot(snap, cachedImports, 'import'));
            onSnapshot(qExport, (snap) => handleSnapshot(snap, cachedExports, 'export'));
            window.listenersActive = true;
        }
    }

    // Hàm lấy ngày từ log để đưa vào dropdown
    function extractDateFromLog(log) {
        let ts = 0;
        if (log.timestamp) {
            if (log.timestamp.seconds) ts = log.timestamp.seconds * 1000;
            else if (typeof log.timestamp.toDate === 'function') ts = log.timestamp.toDate().getTime();
            else ts = new Date(log.timestamp).getTime();
        }
        if (ts > 0) {
            const d = new Date(ts);
            const dateStr = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
            availableDates.add(dateStr);
        }
    }

    function rebuildIndexAndRender() {
        importsByPid = {};
        exportsByPid = {};

        cachedImports.forEach(log => {
            if (log.productId) {
                if (!importsByPid[log.productId]) importsByPid[log.productId] = [];
                importsByPid[log.productId].push(log);
            }
        });

        cachedExports.forEach(log => {
            if (log.productId) {
                if (!exportsByPid[log.productId]) exportsByPid[log.productId] = [];
                exportsByPid[log.productId].push(log);
            }
        });

        renderReport();
    }

    // --- 5. TÍNH TOÁN CORE (CHÍNH XÁC) ---
    function getStats(pid, currentStock, targetDateStr) {
        let nhapTrongNgay = 0;
        let xuatTrongNgay = 0;
        let bienDongSauNgayDo = 0; 

        const [d, m, y] = targetDateStr.split('/').map(Number);
        const startOfDay = new Date(y, m - 1, d, 0, 0, 0, 0).getTime();
        const endOfDay = new Date(y, m - 1, d, 23, 59, 59, 999).getTime();

        const imports = importsByPid[pid] || [];
        const exports = exportsByPid[pid] || [];

        const processLogs = (logs, type) => {
            logs.forEach(log => {
                let ts = 0;
                if (log.timestamp) {
                    if (log.timestamp.seconds) ts = log.timestamp.seconds * 1000;
                    else if (typeof log.timestamp.toDate === 'function') ts = log.timestamp.toDate().getTime();
                    else ts = new Date(log.timestamp).getTime();
                }

                const qty = Number(log.qty || 0);

                if (ts > 0) {
                    if (ts >= startOfDay && ts <= endOfDay) {
                        if (type === 'import') nhapTrongNgay += qty;
                        if (type === 'export') xuatTrongNgay += qty;
                    }
                    if (ts > endOfDay) {
                        if (type === 'import') bienDongSauNgayDo += qty; 
                        if (type === 'export') bienDongSauNgayDo -= qty; 
                    }
                }
            });
        };

        processLogs(imports, 'import');
        processLogs(exports, 'export');

        const tonCuoi = currentStock - bienDongSauNgayDo;
        const tonDau = tonCuoi - nhapTrongNgay + xuatTrongNgay;

        return { nhap: nhapTrongNgay, xuat: xuatTrongNgay, tonDau, tonCuoi };
    }

    // --- 6. RENDER REPORT (CHỈ HIỆN KHI CÓ NHẬP HOẶC XUẤT) ---
    // --- 6. RENDER REPORT (LOGIC MỚI: TÁCH RỜI TÍNH TOÁN VÀ VẼ) ---
    window.renderReport = function() {
        isSwapped = false;
        const body = document.getElementById('product-list-body');
        if (!body) return;

        // 1. Reset dữ liệu cũ
        body.innerHTML = ""; 
        displayList = []; // Xóa danh sách chờ hiển thị
        currentRenderIndex = 0;

        const d = document.getElementById('inp-day').value.padStart(2, '0');
        const m = document.getElementById('inp-month').value.padStart(2, '0');
        const y = document.getElementById('inp-year').value;
        const selectedStr = `${d}/${m}/${y}`;
        const todayStr = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
        const searchText = document.getElementById('searchInput').value.toLowerCase(); // Lấy từ khóa tìm kiếm

        // Cập nhật tiêu đề
        document.getElementById('selected-period-text').innerHTML = 
            `<i class="fas fa-check-circle" style="color:#22c55e"></i> Biến động ngày ${selectedStr}`;

        // Biến tổng để cập nhật thẻ Stat
        let visibleCount = 0;
        let sumReal = 0, sumHist = 0, sumVal = 0;

        // 2. Vòng lặp tính toán (CHẠY NGẦM, KHÔNG VẼ HTML)
        allProducts.forEach(p => {
            const currentStock = Number(p.stock || 0);
            const stats = getStats(p.id, currentStock, selectedStr);

            // LOGIC LỌC: 
            // - Phải có Nhập hoặc Xuất
            // - Nếu đang tìm kiếm: Tên hoặc SKU phải chứa từ khóa
            const hasActivity = (stats.nhap !== 0 || stats.xuat !== 0);
            const matchSearch = p.name.toLowerCase().includes(searchText) || p.sku.toLowerCase().includes(searchText);

            if (hasActivity && matchSearch) {
                visibleCount++;
                const unitCost = Number(p.cost || 0);
                const totalImport = stats.nhap * unitCost;
                const totalStock = stats.tonCuoi * unitCost;

                // Cộng tổng
                sumReal += currentStock;
                sumHist += stats.tonCuoi;
                sumVal += totalStock;

                // Đẩy vào danh sách chờ vẽ (Lưu Object data để tí nữa vẽ sau)
                displayList.push({
                    p, stats, unitCost, totalImport, totalStock
                });
            }
        });

        // 3. Cập nhật Thống kê (Header) ngay lập tức
        document.getElementById('total-types').innerText = visibleCount;
        document.getElementById('total-quantity-current').innerText = sumReal.toLocaleString();
        document.getElementById('total-value-report').innerText = sumVal.toLocaleString() + 'đ';

        const hBox = document.getElementById('history-qty-box');
        if (selectedStr === todayStr) hBox.style.display = 'none';
        else {
            hBox.style.display = 'block';
            document.getElementById('history-date-label').innerText = `Chốt ngày ${selectedStr}`;
            document.getElementById('total-quantity-history').innerText = sumHist.toLocaleString();
        }

        // 4. Bắt đầu vẽ 25 dòng đầu tiên
        if (displayList.length === 0) {
            body.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:50px; color:#64748b;">Không có dữ liệu phù hợp</td></tr>';
        } else {
            renderNextBatch(); // Gọi hàm vẽ theo lô
        }
    };


    // --- HÀM MỚI: VẼ TỪNG LÔ 25 DÒNG ---
    function renderNextBatch() {
        const body = document.getElementById('product-list-body');
        
        // Nếu đã vẽ hết thì dừng
        if (currentRenderIndex >= displayList.length) return;

        // Lấy 25 item tiếp theo từ danh sách
        const nextBatch = displayList.slice(currentRenderIndex, currentRenderIndex + BATCH_SIZE);
        
        let htmlFragment = "";
        
        nextBatch.forEach(item => {
            const { p, stats, unitCost, totalImport, totalStock } = item;
            
            htmlFragment += `
                <tr>
                    <td>
                        <div class="product-info">
                            <img src="${p.img && p.img.length > 20 ? p.img : 'https://placehold.co/50x50'}" class="product-img">
                            <div><span class="product-name">${p.name}</span><span class="product-sku">${p.sku}</span></div>
                        </div>
                    </td>
                    <td class="highlight-dau">${stats.tonDau.toLocaleString()}</td>
                    <td>${stats.nhap > 0 ? `<span class="text-bold" style="color:#16a34a">+${stats.nhap.toLocaleString()}</span>` : '-'}</td>
                    <td>${stats.xuat > 0 ? `<span class="text-bold" style="color:#ef4444">-${stats.xuat.toLocaleString()}</span>` : '-'}</td>
                    <td style="color:#64748b; font-weight:600;">${unitCost > 0 ? unitCost.toLocaleString() + 'đ' : '-'}</td>
                    <td style="color:#16a34a; font-weight:700; background:#f0fdf4;">${totalImport > 0 ? totalImport.toLocaleString() + 'đ' : '-'}</td>
                    <td class="highlight-cuoi">${stats.tonCuoi.toLocaleString()}</td>
                    <td class="text-bold clickable-total" style="color:#1e293b;" onclick="showFormula(this)">${totalStock > 0 ? totalStock.toLocaleString() + 'đ' : '-'}</td>
                </tr>
            `;
        });

        // Chèn thêm vào bảng (không xóa cái cũ)
        body.insertAdjacentHTML('beforeend', htmlFragment);
        
        // Cập nhật chỉ số
        currentRenderIndex += BATCH_SIZE;
    }


    // --- 7. UI EVENTS & DROPDOWN ---
    function renderHistoryDropdown() {
        const list = document.getElementById('period-list');
        if(!list) return;

        const sorted = Array.from(availableDates).sort((a,b) => {
            const [d1,m1,y1]=a.split('/').map(Number), [d2,m2,y2]=b.split('/').map(Number);
            return new Date(y2,m2-1,d2) - new Date(y1,m1-1,d1);
        });

        if (sorted.length === 0) {
            list.innerHTML = '<li class="dropdown-item" style="color:#94a3b8">Chưa có lịch sử gần đây</li>';
        } else {
            list.innerHTML = sorted.map(d => 
                `<li class="dropdown-item" onclick="window.selectHistoryDate('${d}')">
                    <i class="fas fa-calendar-check" style="color:#3b82f6"></i> ${d}
                </li>`
            ).join('');
        }
    }

    window.performSwap = function() {
        const rows = document.querySelector('.inventory-table').rows;
        for (let i = 0; i < rows.length; i++) {
            if (rows[i].cells.length > 5) rows[i].insertBefore(rows[i].cells[5], rows[i].cells[4]);
        }
    };
    window.showFormula = function(cell) {
        const wasActive = cell.classList.contains('formula-active');
        document.querySelectorAll('.formula-active').forEach(el => el.classList.remove('formula-active'));
        if (wasActive) {
            if (isSwapped) { window.performSwap(); isSwapped = false; }
        } else {
            if (!isSwapped) { window.performSwap(); isSwapped = true; }
            const cells = cell.closest('tr').querySelectorAll('td');
            if(cells[5]) cells[5].classList.add('formula-active');
            if(cells[6]) cells[6].classList.add('formula-active');
            if(cells[7]) cells[7].classList.add('formula-active');
        }
    };

    window.selectHistoryDate = function(d) {
        const [day, m, y] = d.split('/');
        document.getElementById('inp-day').value = day;
        document.getElementById('inp-month').value = m;
        document.getElementById('inp-year').value = y;
        document.getElementById('period-list').classList.remove('show');
        renderReport(); // Không cần tải lại dữ liệu, chỉ render lại
    };

    window.toggleDropdown = () => document.getElementById('period-list').classList.toggle('show');
    window.onclick = (e) => { if(!e.target.closest('#period-dropdown')) document.getElementById('period-list').classList.remove('show'); };
    



    // --- HÀM MỚI: TỰ ĐỘNG XÓA DỮ LIỆU CŨ HƠN 7 THÁNG ---
    async function autoCleanOldData() {
        if (!currentStoreId) return;

        // 1. Tính mốc thời gian (Lấy ngày hiện tại trừ đi 7 tháng)
        const cutoffDate = new Date();
        cutoffDate.setMonth(cutoffDate.getMonth() - 7);
        
        // Log ra console để bạn kiểm tra (F12)
        console.log("Đang quét dữ liệu cũ hơn ngày:", cutoffDate.toLocaleDateString('vi-VN'));

        const logTypes = ["import_log", "export_log"];

        for (const type of logTypes) {
            // Query tìm dữ liệu cũ hơn mốc 7 tháng
            // limit(500) để xóa theo lô, tránh lỗi quá tải
            const q = query(
                collection(db, "warehouse_history_logs", currentStoreId, type),
                where("timestamp", "<", cutoffDate),
                limit(500) 
            );

            try {
                // Lấy dữ liệu (chỉ lấy để xóa, không hiện lên UI)
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    
                    await batch.commit(); // Thực lệnh xóa
                    console.log(`Đã xóa vĩnh viễn ${snapshot.size} dòng lịch sử cũ quá 7 tháng ở bảng ${type}`);
                }
            } catch (err) {
                console.warn("Chưa thể dọn dẹp dữ liệu cũ (có thể do chưa Index hoặc mạng):", err);
            }
        }
    }


    // --- 8. KHỞI ĐỘNG ---
    // --- 8. KHỞI ĐỘNG (CẬP NHẬT SCROLL LISTENER) ---
    function startApp() {
        if (!currentStoreId) return;
        loadSidebar();
        
        // Sự kiện: Lăn chuột tải thêm
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            mainContent.addEventListener('scroll', () => {
                // Tính toán vị trí lăn: ScrollTop + ClientHeight >= 90% ScrollHeight
                if (mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight * 0.9) {
                    renderNextBatch();
                }
            });
        }

        // Sự kiện: Input ngày thay đổi
        ['inp-day','inp-month','inp-year'].forEach(id => {
            document.getElementById(id).addEventListener('keyup', () => renderReport());
            document.getElementById(id).addEventListener('change', () => renderReport());
        });
        
        // Sự kiện: Tìm kiếm (Sửa lại để nó gọi renderReport thay vì ẩn CSS thủ công)
        // Vì ẩn CSS thủ công sẽ bị lỗi với Lazy Load (dữ liệu chưa tải thì sao ẩn được?)
        document.getElementById('searchInput').onkeyup = () => renderReport(); 
        
        // --- GỌI HÀM RÀNG BUỘC NGÀY ---
        setupDateConstraints();


        autoCleanOldData();

        updateProgress(10, "Đang tải sản phẩm...");
        
        onSnapshot(collection(db, "products"), (snap) => {
            allProducts = snap.docs.map(d => ({id:d.id, ...d.data()})).filter(p => p.storeId === currentStoreId);
            loadLogsAndCalendar();
        });
    }
    startApp();



    // --- HÀM MỚI: RÀNG BUỘC NGÀY NHẬP (KHÔNG ĐƯỢC VƯỢT QUÁ HÔM NAY) ---
    // --- CẬP NHẬT: RÀNG BUỘC NGÀY (CHẶN TƯƠNG LAI & QUÁ KHỨ 2 NĂM) ---
    function setupDateConstraints() {
        const dInput = document.getElementById('inp-day');
        const mInput = document.getElementById('inp-month');
        const yInput = document.getElementById('inp-year');

        const validateDate = () => {
            const now = new Date();
            const curD = now.getDate();
            const curM = now.getMonth() + 1;
            const curY = now.getFullYear();
            
            // --- 1. TÍNH NĂM TỐI THIỂU (HIỆN TẠI TRỪ 2) ---
            const minYear = curY - 2;

            let d = parseInt(dInput.value) || curD;
            let m = parseInt(mInput.value) || curM;
            let y = parseInt(yInput.value) || curY;

            // --- 2. LOGIC CHẶN NĂM (QUÁ KHỨ & TƯƠNG LAI) ---
            if (y < minYear) y = minYear; // Nếu nhập 2023 (thấp hơn 2024) -> Về 2024
            if (y > curY) y = curY;       // Nếu nhập 2027 -> Về 2026

            // Logic kiểm tra tháng/ngày (Giữ nguyên như cũ)
            if (y === curY && m > curM) m = curM;
            if (y === curY && m === curM && d > curD) d = curD;

            // Kiểm tra số ngày trong tháng
            const maxDaysInMonth = new Date(y, m, 0).getDate();
            if (d > maxDaysInMonth) d = maxDaysInMonth;
            if (d < 1) d = 1;
            if (m < 1) m = 1;

            // Gán lại giá trị
            dInput.value = String(d).padStart(2, '0');
            mInput.value = String(m).padStart(2, '0');
            yInput.value = y;

            if (typeof window.renderReport === 'function') window.renderReport();
        };

        [dInput, mInput, yInput].forEach(inp => {
            inp.addEventListener('change', validateDate);
            inp.addEventListener('input', (e) => e.target.value = e.target.value.replace(/[^0-9]/g, ''));
        });
    }
    
</script>


</body>
</html>