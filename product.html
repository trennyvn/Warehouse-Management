<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sản phẩm - Warehouse Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/sidebar.css"> 
    
    <style>
           /* Áp dụng Baloo 2 cho toàn bộ trang web */

        body { background-color: #dbedff; color: #334155; }

/* =========================================
   1. CẤU TRÚC CHUNG (BASE) & HIỆU ỨNG NỀN
   ========================================= */
body {
    font-family: 'Baloo 2', cursive;
    margin: 0;
    min-height: 100vh;
    width: 100vw;
    display: flex;
    overflow: hidden;
    user-select: none;
    position: relative;
    background: #eef2f7; 
}

/* Lớp sóng màu uốn lượn phía sau - GIỮ NGUYÊN */
body::after {
    content: "";
    position: fixed;
    width: 150vmax;
    height: 150vmax;
    top: -25%;
    left: -25%;
    z-index: -1;
    background-image: 
        radial-gradient(circle at 20% 30%, #d0bcff 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, #a1c4fd 0%, transparent 40%),
        radial-gradient(circle at 50% 50%, #c2e9fb 0%, transparent 50%);
    filter: blur(80px);
    animation: waveMovement 15s linear infinite;
}

@keyframes waveMovement {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

body::before {
    content: "";
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.6) 0%, transparent 80%);
    pointer-events: none;
    z-index: -1;
}

.table-view {
    display: flex;
    width: 100%;
    min-height: 100vh;
    padding: 20px;
    gap: 10px;
}

.table-view > div {
  border-radius: 15px;
}





/* =========================================
   2. MAIN CONTENT & THANH CUỘN NƯỚC (GIỮ NGUYÊN)
   ========================================= */
.main-content {
    scrollbar-width: none;
    -ms-overflow-style: none;
    position: relative;
    flex: 1;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 40px);
    overflow: hidden;
    background: #fff;
    border-radius: 15px;
}

.main-content::-webkit-scrollbar {
    display: none;
}

.water-scrollbar-container {
    position: absolute;
    right: 0 !important;
    top: 0 !important;
    bottom: 0 !important;
    width: 25px;
    background: rgba(0, 229, 255, 0.05);
    border-left: 3px solid #f4f4fc;
    border-radius: 0 15px 15px 0;
    z-index: 10000;
    overflow: hidden;
    display: flex;
    flex-direction: column; 
    pointer-events: none;
}

.water-fill {
    width: 100%;
    height: 10%;
    min-height: 50px;
    background: linear-gradient(to bottom, #ffffff, #b5b5ec);
    border-radius: 0 0 10px 0;
    transition: height 0.1s linear;
    position: relative;
    box-shadow: inset -2px 0 5px rgba(255,255,255,0.3);
}

.table-container {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 20px 20px;
    scrollbar-width: none;
}

.table-container::-webkit-scrollbar {
    display: none;
}

.content-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
    padding: 0;
    background: transparent;
    min-height: auto;
}




/* =========================================
   4. CÁC THÀNH PHẦN KHÁC (DROPDOWN, POPUP, BTN...) - GIỮ NGUYÊN
   ========================================= */

/* Header & Title */
.page-title {
    font-size: 25px; font-weight: 700; color: #1a1a1a;
    display: flex; align-items: center; margin: 0;
}
.page-title i { margin-right: 12px; color: #f39c12; }

.top-header {
    display: flex; align-items: center; justify-content: space-between; 
    padding: 0 20px; padding-right: 50px; height: 70px; 
}



@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }



/* Image Containers */
.img-container {
    width: 60px; height: 60px; border-radius: 12px; overflow: hidden;
    margin: 0 auto; border: 1px solid #eef2f6; background: #fff;
    box-shadow: 0px 2px 0px 1px rgb(200, 200, 200); transition: all 0.3s ease;
}
.img-container:hover { transform: translateY(-2px); box-shadow: 0px 4px 0px 1px rgb(200, 200, 200); }
.img-container img { width: 100%; height: 100%; object-fit: cover; }

/* Inline Inputs in Table */
.inline-input {
    width: 100%; border: 1px solid transparent; background: transparent;
    padding: 4px; border-radius: 4px; text-align: center;
    font-family: inherit; font-size: 14px; color: #475569;
}
.inline-input:hover { border-color: #e2e8f0; background: #fff; }
.inline-input:focus { border-color: #0056e0; background: #fff; outline: none; }

/* Bỏ mũi tên tăng giảm của input number cho đẹp */
.inline-input::-webkit-inner-spin-button,
.inline-input::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Category Tags */
.cat-text { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; display: inline-block; }
.cat-text:hover { background-color: #f1f5f9; color: #0056e0; }
.cat-text i {
    font-size: 10px;
    margin-left: 5px;
    opacity: 0.5;
}
.cat-unassigned {
    color: #ef4444 !important; background-color: #fef2f2;
    padding: 3px 8px; border-radius: 4px; font-weight: 700;
}


/* Icon dấu chấm than */
.cat-unassigned i {
    font-size: 12.5px;
}

/* Checkbox & Selection */
.product-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #0056e0; }

/* Màu nền cho hàng khi được chọn - thêm !important để không bị hover đè */
tr.selected-row td {
    background-color: #f0f7ff !important; 
}

/* Đảm bảo khi hover vào hàng đã chọn, nó không bị đổi về màu trắng/xám */
tr.selected-row:hover td {
    background-color: #e0efff !important;
}   
/* Modal & Utils */
.modal-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); 
    display: none; justify-content: center; align-items: center; z-index: 9999; 
}
.modal-overlay img { max-width: 90%; max-height: 90%; border-radius: 8px; animation: zoomIn 0.3s ease; }
@keyframes zoomIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }


        /* =========================================
           2. THÀNH PHẦN (COMPONENTS)
           ========================================= */
        .filter-group { display: flex; gap: 15px; margin-bottom: 25px; align-items: center; }
        .filter-input-wrapper { position: relative; width: 280px; }
        .filter-input-wrapper input { 
            width: 100%; padding: 10px 40px 10px 15px; border: 1px solid #e2e8f0; 
            border-radius: 8px; font-size: 14px; background: white; color: #64748b; 
        }
        .filter-input-wrapper i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #64748b; }
        
        .select-wrapper { position: relative; display: flex; align-items: center; }

        /* Thẻ select chính */
.filter-select {
    appearance: none;
    -webkit-appearance: none;
    padding: 10px 40px 10px 16px; /* Tăng padding để thoáng chữ */
    border: 1.5px solid #e2e8f0; /* Viền nét hơn */
    border-radius: 10px; /* Bo góc mượt hơn */
    background: white;
    font-size: 14px;
    font-weight: 600; /* Chữ đậm hơn tí cho sang */
    color: #475569;
    cursor: pointer;
    min-width: 200px;
    outline: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

/* Hiệu ứng khi di chuột vào hoặc nhấn vào */
.filter-select:hover {
    border-color: #0056e0;
    background-color: #f8fbff;
}

.filter-select:focus {
    border-color: #0056e0;
    box-shadow: 0 0 0 4px rgba(0, 86, 224, 0.1); /* Hiệu ứng tỏa sáng blue */
}

        /* Icon mũi tên */
.select-wrapper i {
    position: absolute;
    right: 15px;
    pointer-events: none;
    font-size: 12px;
    color: #94a3b8;
    transition: transform 0.3s ease;
}

/* Khi người dùng click (focus), icon mũi tên xoay ngược lại */
.select-wrapper:focus-within i {
    transform: rotate(180deg);
    color: #0056e0;
}



        /* --- Nút bấm --- */

        .header-actions{display:flex; gap:10px;}

        .btn-primary { 
            background: #0056e0; color: white; border: none; padding: 10px 20px; border-radius: 8px; 
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; transition: 0.2s ease-in-out;
        }
        .btn-primary:hover{
            background: #ffffff; color: #0056e0; outline: 1px solid #777777; 
        }
        /* Nút thùng rác tổng mặc định */
.btn-trash-general {
    background: white;
    border: 1px solid #e2e8f0;
    color: #94a3b8; /* Màu xám nhẹ lúc bình thường */
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Khi có ít nhất 1 hàng được chọn: Sáng lên và có hiệu ứng hover */
.btn-trash-general.active {
    opacity: 1;
    pointer-events: auto;
    border-color: #fecaca;
    color: #ef4444;
}

.btn-trash-general.active:hover {
    background: #fff1f2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
}

/* Hiệu ứng Hover - Đổi sang tông đỏ nguy hiểm */
.btn-trash-general:hover {
    background-color: #fff1f2; /* Nền hồng nhạt */
    color: #ef4444;           /* Màu đỏ tươi */
    border-color: #fecaca;    /* Viền đỏ nhạt */
    transform: translateY(-2px); /* Nhấc nhẹ nút lên */
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15); /* Đổ bóng đỏ nhẹ */
}

/* Hiệu ứng rung nhẹ khi hover để gây chú ý */
.btn-trash-general:hover i {
    animation: shake 0.5s infinite;
}

/* Định nghĩa hiệu ứng rung */
@keyframes shake {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(10deg); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-10deg); }
    100% { transform: rotate(0deg); }
}

/* Hiệu ứng khi nhấn vào (Click) */
.btn-trash-general:active {
    transform: scale(0.95);
    background-color: #fee2e2;
}
        .btn-delete { background: none; border: none; color: #cbd5e0; cursor: pointer; font-size: 18px; opacity: 0.6; }

/* =========================================
   3. BẢNG DỮ LIỆU - FIX LỖI CĂN GIỮA TUYỆT ĐỐI
   ========================================= */
table { 
    width: 100%; 
    border-collapse: collapse; 
    table-layout: fixed; /* Ép các cột tuân thủ kích thước bên dưới */
    min-width: 1100px; 
}

/* ĐỊNH NGHĨA WIDTH TỪNG CỘT */
.col-img    { width: 85px; }
.col-name   { width: 125px; } /* Cột tên rộng rãi */
.col-sku    { width: 130px; }
.col-cat    { width: 150px; }
.col-stock  { width: 100px; }
.col-unit   { width: 100px; }
.col-cost   { width: 130px; }
.col-total  { width: 200px; } /* THÀNH TIỀN RỘNG NHẤT NHƯ YÊU CẦU */
.col-action { width: 60px; }

/* Header & Cell Style */
th, td {
    padding: 15px 10px;
    text-align: center; /* TẤT CẢ CĂN GIỮA ĐỂ THẲNG HÀNG */
    vertical-align: middle;
}

th {
    background: #f8fafc;
    font-size: 14px;
    font-weight: 700;
    color: #64748b;
    text-transform: uppercase;
    border-bottom: 2px solid #e2e8f0;
}

/* Tên sản phẩm - Đảm bảo text cũng căn giữa bên trong div */
.product-name-text {
    font-weight: 700;
    color: #334155;
    font-size: 15px;
    text-align: center; /* Căn giữa nội dung */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    width: 100%;
}

#product-list-body tr {
    border-bottom: 1px solid #eeeeee;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
    
 
}

/* Hiệu ứng nhấc dòng khi hover */
#product-list-body tr:hover {
    background-color: #fff !important; 
    transform: translateY(-5px);          
    box-shadow: inset 0 -2.5px 1px 5px rgb(240, 240, 240), 0 6px 12.5px -5px rgb(0, 238, 255);  
    z-index: 10;
}

/* Căn trái riêng cho tiêu đề Tên SP */
th.col-name { text-align: left; padding-left: 20px; }

td {
    padding: 14px 10px !important;
    text-align: center;
    vertical-align: middle;
}

/* Căn trái riêng cho nội dung Tên SP */
th.col-name,
td.col-name {
    text-align: center;
    padding-left: 0;
}


.product-name-text {
    color: #334155;
    font-size: 15px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
}

/* Badge SKU */
.sku-badge {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    color: #64748b;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 13px;
    display: inline-block;
}

/* Hiệu ứng Hover dòng - GIỮ NGUYÊN */
#product-list-body tr {
    border-bottom: 1px solid #eeeeee;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative; 
    font-size: 17.5px;
}

#product-list-body tr:hover {
    background-color: rgb(255, 255, 255) !important; 
    transform: translateY(-5px);          
    box-shadow: inset 0 -2.5px 1px 5px rgb(240, 240, 240), 0 6px 12.5px -5px rgb(0, 238, 255);  
    z-index: 10;
}

#product-list-body tr:hover td {
    background-color: transparent !important;
}


/* 3. QUAN TRỌNG: Đổi màu chữ khi nền biến thành màu đỏ để dễ đọc */
#product-list-body tr:hover td, 
#product-list-body tr:hover span, 
#product-list-body tr:hover div {
    color: #333 !important; /* Chữ trắng trên nền đỏ cho dễ nhìn */
}

/* 4. Đảm bảo td không đè màu lên tr */
#product-list-body tr:hover td {
    background-color: transparent !important;
}



/* 3. Danh mục: Chuyển sang căn giữa */
th.col-cat, td.col-cat { width: 125px; text-align: center; }

/* 4. Tồn kho: Căn giữa */
th.col-stock, td.col-stock { width: 100px; text-align: center; }

/* 5. Giá vốn: Chuyển sang căn giữa (hoặc phải tùy bạn, ở đây mình để giữa theo ý bạn) */
th.col-cost, td.col-cost   { width: 120px; text-align: center; } 

/* 6. Giá bán: Chuyển sang căn giữa */
th.col-price, td.col-price { width: 120px; text-align: center; } 

/* Các cột còn lại giữ nguyên căn giữa */
th.col-sku, td.col-sku     { width: 110px; text-align: center; }
th.col-safe, td.col-safe   { width: 90px;  text-align: center; }
th.col-date, td.col-date   { width: 130px; text-align: center; }
th.col-action, td.col-action { width: 60px; text-align: center; }




/* --- TRANG TRÍ NỘI DUNG BÊN TRONG --- */



/* Tên sản phẩm - Giới hạn 2 dòng */
.product-name-text {
    font-weight: 600; color: #1e293b;
    -webkit-box-orient: vertical; overflow: hidden;
    line-height: 1.4;
}

/* Hiệu ứng hover dòng */
tr:hover td { background-color: #f8fbff; }

.img-product { width: 100%; height: 100%; object-fit: cover; }

        .img-product { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: zoom-in; opacity: 0.9; display: block; margin: 0 auto; }
        .stock-tag { font-weight: 700; font-size: 15px; }
        
        
        .date-badge { 
            background: #fff5f5; color: #c53030; padding: 4px 12px; border-radius: 20px; 
            border: 1px solid #feb2b2; font-size: 13px; display: inline-block; white-space: nowrap; 
        }


    






        .btn-delete:hover { color: #ef4444; transform: scale(1.2); }
        @keyframes zoomIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Custom Dropdown Category */
  
  

        .search-box input { 
            width: 100%; padding: 8px; border: 1px solid #111; border-radius: 6px; margin-bottom: 10px; outline: none;
        }
        #categoryList { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
        #categoryList li { padding: 8px 12px; cursor: pointer; border-radius: 4px; font-size: 14px; text-align: left; }
        #categoryList li:hover { background-color: #f1f5f9; }

        /* Nút thùng rác mặc định */
.btn-delete {
    background: #fff1f2; /* Nền hồng rất nhạt */
    border: none;
    color: #fda4af; /* Màu đỏ nhạt mặc định */
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

/* Hiệu ứng Hover - Thùng rác rực lên */
.btn-delete:hover {
    background: #ffe4e6; /* Nền đậm hơn tí */
    color: #e11d48; /* Màu đỏ rực */
    transform: scale(1.15) rotate(5deg); /* Phóng to và hơi nghiêng một chút */
    box-shadow: 0 4px 12px rgba(225, 29, 72, 0.15);
}

/* Hiệu ứng khi bấm vào (Active) */
.btn-delete:active {
    transform: scale(0.95);
}

/* TỔNG HỢP CSS CHO DROPDOWN CUSTOM */
.custom-select-container {
    position: relative;
    min-width: 200px; /* Độ rộng đồng nhất cho cả Sắp xếp và Danh mục */
}

.select-trigger {
    padding: 10px 16px;
    border: 1.5px solid #e2e8f0;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    font-weight: 600;
    color: #475569;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.select-trigger:hover {
    border-color: #0056e0;
    background-color: #f8fbff;
}

/* Bảng trắng hiện ra bên trong */
.dropdown-content {
    display: none;
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    width: 100%;
    min-width: 220px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    z-index: 1000;
    padding: 8px;
    animation: slideDown 0.2s ease;
}

.dropdown-content.show {
    display: block;
}

/* Các mục bên trong danh sách */
.dropdown-content ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.dropdown-content li {
    padding: 10px 15px;
    font-size: 14px;
    font-weight: 500;
    color: #475569;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.dropdown-content li:hover {
    background-color: #f1f5f9;
    color: #0056e0;
}

/* Hiệu ứng xoay mũi tên */
.custom-select-container.show .fa-chevron-down {
    transform: rotate(180deg);
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Màu sắc và kiểu dáng cho các mục đặc biệt */
.cat-item-special {
    font-weight: 700 !important; /* Đậm hơn hẳn */
    margin-bottom: 2px;
}

/* Mục Tất cả danh mục - Màu xanh chuyên nghiệp */
.cat-all {
    color: #0056e0 !important;
    background-color: #f0f7ff;
}

/* Mục Chưa phân loại - Màu cam/đỏ cảnh báo nhẹ */
.cat-none {
    color: #f97316 !important;
    background-color: #fff7ed;
}

/* Icon đi kèm cho sinh động */
.cat-item-special i {
    margin-right: 8px;
    font-size: 12px;
}

/* Hiệu ứng hover riêng cho mục đặc biệt */
.cat-all:hover {
    background-color: #e0efff !important;
}

.cat-none:hover {
    background-color: #ffedd5 !important;
}





/* Nút thùng rác khi có sản phẩm được chọn */
#mainTrashBtn.active {
    opacity: 1;
    pointer-events: auto;
    color: #ef4444;
    border-color: #ef4444;
}

/* Khung chứa ảnh khi trống */
.img-container.empty-bg {
    background-color: #f8fafc; /* Màu nền xám cực nhẹ */
    border: 1px dashed #cbd5e1; /* Viền đứt nét nhẹ nhàng */
}

/* Làm icon mặc định nhỏ lại một chút và mờ đi cho tinh tế */
.no-img-opacity {
    opacity: 0.4;
    
    padding: 10px; /* Tạo khoảng trống xung quanh icon no-image */
}






/* Style cho Popup Chọn Danh Mục Nhanh */
.quick-cat-popup {
    display: none; /* Mặc định ẩn */
    position: absolute;
    width: 280px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    border: 1px solid #e2e8f0;
    z-index: 1000;
    overflow: hidden;
    animation: fadeIn 0.15s ease-out;
}

/* Ô tìm kiếm trong popup */
.quick-cat-search {
    padding: 10px;
    border-bottom: 1px solid #f1f5f9;
    position: relative;
    display: flex;
    align-items: center;
}
.quick-cat-search i {
    position: absolute;
    left: 20px;
    color: #94a3b8;
    font-size: 13px;
}
.quick-cat-search input {
    width: 100%;
    padding: 8px 10px 8px 32px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 13px;
    outline: none;
    transition: border 0.2s;
}
.quick-cat-search input:focus {
    border-color: #3b82f6;
}

/* Danh sách cuộn */
.quick-cat-list {
    list-style: none;
    margin: 0;
    padding: 0;
    max-height: 250px;
    overflow-y: auto;
}
.quick-cat-list li {
    padding: 10px 15px;
    font-size: 13px;
    color: #334155;
    cursor: pointer;
    border-bottom: 1px solid #f8fafc;
    transition: background 0.1s;
}
.quick-cat-list li:hover {
    background-color: #eff6ff;
    color: #1d4ed8;
}
.quick-cat-list li.active {
    background-color: #e0e7ff;
    font-weight: 600;
}

/* Animation nhẹ */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
















    </style>
</head>


















<body>

<div class="table-view"> 
    <div class="sidebar"></div>

    <div class="main-content">
        <div class="water-scrollbar-container">
            <div class="water-fill" id="waterLevel"></div>
        </div>

        <div class="header-container top-header">
            <h2 class="page-title">
                <i class="fa-solid fa-box-archive" style="padding-right: 10px;"></i>Sản phẩm
            </h2>
            
            <div class="header-actions">

                <button onclick="window.location.href='/Warehouse-Management/add-products.html'" class="btn-primary">
                    <i class="fa-solid fa-circle-plus"></i> Sản phẩm
                </button>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="filter-group" style="padding: 0 20px;">
                <div class="filter-input-wrapper">
                    <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên" onkeyup="searchProducts()">
                    <i class="fa-solid fa-barcode"></i>
                </div>
                
                <div class="custom-select-container" id="sortDropdown">
                    <div class="select-trigger" onclick="toggleSortDropdown()">
                        <span id="selectedSortText">Sắp xếp: Mặc định</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-content" id="sortContent">
                        <ul>
                            <li onclick="applySort('stock-asc', 'Stock Thấp đến Cao')">Stock Thấp đến Cao</li>
                            <li onclick="applySort('stock-desc', 'Stock Cao đến Thấp')">Stock Cao đến Thấp</li>
                            <li onclick="applySort('name-asc', 'Tên A-Z')">Tên A-Z</li>
                            <li onclick="applySort('name-desc', 'Tên Z-A')">Tên Z-A</li>
                            <li onclick="applySort('date-asc', 'Hết hạn gần nhất')">Hết hạn gần nhất</li>
                            <li onclick="applySort('date-desc', 'Hết hạn xa nhất')">Hết hạn xa nhất</li>
                        </ul>
                    </div>
                </div>

                <div class="custom-select-container" id="categoryDropdown">
                    <div class="select-trigger" onclick="toggleDropdown()">
                        <span id="selectedCategoryText">Danh mục</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-content" id="categoryContent">
                        <div class="search-box">
                            <input type="text" id="categorySearch" placeholder="Tìm kiếm danh mục..." onkeyup="filterCategoryList()" style="width:100%; border:1px solid #e2e8f0; margin-bottom:8px;">
                        </div>
                        <ul id="categoryList"></ul>
                    </div>
                </div>

                <button class="btn-trash-general" id="mainTrashBtn" onclick="deleteSelectedProducts()">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="col-img">Ảnh</th>
                            <th class="col-name">Tên Sản Phẩm</th>
                            <th class="col-sku">SKU</th>
                            <th class="col-cat">Phân Loại</th>
                            <th class="col-stock">Số Lượng</th>
                            <th class="col-unit">Đơn Vị</th>
                            <th class="col-cost">Giá Nhập</th>
                            <th class="col-total">Thành Tiền</th> <!-- Cột này sẽ dài nhất nhờ CSS ở trên -->
                            <!-- Đã xóa cột Hết hạn -->
                            <th class="col-action">
                                <i class="fa-regular fa-square-minus" id="toggleAllIcon" 
                                style="cursor: pointer; font-size: 18px; color: #64748b;" 
                                onclick="toggleAllCheckboxes()"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="product-list-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal-overlay" onclick="this.style.display='none'">
        <img id="modalImg" src="">
    </div>

    <div id="quickCategoryPopup" class="quick-cat-popup">
        <div class="quick-cat-search">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" id="quickCatSearch" placeholder="Tìm hoặc tạo danh mục..." onkeyup="filterQuickCategory()">
        </div>
        <ul id="quickCatList" class="quick-cat-list"></ul>
    </div>
</div>



<!-- ================================================================ -->
<!-- SCRIPT FINAL: BẢO MẬT CAO + KHÓA SỬA SỐ LƯỢNG -->
<!-- ================================================================ -->


<!-- ###################################################################### -->
<!-- SCRIPT ĐÃ FIX LỖI RELOAD & DROPDOWN -->
<!-- ###################################################################### -->
<script>
    // 1. TẢI SIDEBAR & PROFILE (Chạy độc lập để hiển thị nhanh)
    (function() {
        const userLoggedIn = localStorage.getItem('userLoggedIn');
        if (userLoggedIn !== 'true') { window.location.replace('/index.html?auth=required'); return; }
        
        fetch('/Warehouse-Management/Side-Bar.html')
            .then(res => res.text())
            .then(data => {
                const container = document.getElementById('sidebar-container');
                if (container) {
                    container.innerHTML = data;
                    // Cập nhật Profile sau khi Sidebar đã hiện
                    setTimeout(() => {
                        const name = localStorage.getItem('userName');
                        const pic = localStorage.getItem('userPicture');
                        const email = localStorage.getItem('userEmail');
                        
                        const nameEl = document.getElementById('set-name');
                        if (nameEl) nameEl.textContent = name || "Người dùng";
                        
                        const emailEl = document.getElementById('set-email');
                        if (emailEl) emailEl.textContent = email || "...";

                        const avatarEl = document.getElementById('set-avatar');
                        if (avatarEl) {
                            if (pic && pic !== "null") {
                                avatarEl.style.backgroundImage = `url('${pic}')`;
                                avatarEl.textContent = ""; 
                            } else if (name) avatarEl.textContent = name.charAt(0).toUpperCase();
                        }
                    }, 100); // Đợi 1 xíu để HTML render xong hẳn
                    
                    // Kích hoạt lại script trong sidebar
                    container.querySelectorAll("script").forEach(oldScript => {
                        const newScript = document.createElement("script");
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                }
            })
            .catch(err => console.error("Lỗi Sidebar:", err));
    })();
</script>

<script type="module">
    import { db } from "../firebase-config.js";
    import { 
        collection, query, where, onSnapshot, 
        doc, deleteDoc, updateDoc, writeBatch, 
        addDoc, serverTimestamp, orderBy, getDoc 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";   

    // --- 1. BIẾN TOÀN CỤC ---
    let cachedProducts = []; 
    let cachedCategories = []; 
    const currentStoreId = localStorage.getItem('current_store_id');
    const userEmail = localStorage.getItem('userEmail');
    
    // Bộ lọc
    let currentSortType = 'stock-asc';
    let currentCategory = 'all';
    let currentEditingId = null; 
    let canEdit = false; // Mặc định khóa

    // ============================================================
    // 2. KHỞI TẠO & CHECK QUYỀN
    // ============================================================
    (function init() {
        const userLoggedIn = localStorage.getItem('userLoggedIn');
        if (userLoggedIn !== 'true') {
            window.location.replace('/index.html?auth=required');
            return;
        }
        
        loadSidebar();

        if (currentStoreId && userEmail) {
            verifyRealPermissions();
            loadProductsRealtime();
            loadCategoriesRealtime();
        }
    })();

    // Check quyền từ Database
    async function verifyRealPermissions() {
        try {
            // 1. Check Chủ sở hữu
            const storeRef = doc(db, "Administrator", currentStoreId);
            const storeSnap = await getDoc(storeRef);
            let isOwner = false;
            
            if (storeSnap.exists()) {
                const ownerEmail = storeSnap.data().ownerEmail;
                if (ownerEmail && ownerEmail.toLowerCase() === userEmail.toLowerCase()) isOwner = true;
            }

            // 2. Check Nhân viên
            const personnelId = `${currentStoreId}_${userEmail.replace(/\./g, '_')}`;
            onSnapshot(doc(db, "gmail_personnel", personnelId), (docSnap) => {
                if (isOwner) {
                    canEdit = true;
                } else if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.role === 'Chủ sở hữu' || data.perms?.products === true) {
                        canEdit = true;
                    } else {
                        canEdit = false;
                    }
                } else {
                    canEdit = false;
                }
                updateUIByPermission();
            });

        } catch (error) {
            console.error("Lỗi quyền:", error);
            canEdit = false;
            updateUIByPermission();
        }
    }

    function updateUIByPermission() {
        const addBtn = document.querySelector('.btn-primary'); 
        const trashBtn = document.getElementById('mainTrashBtn'); 
        const toggleIcon = document.getElementById('toggleAllIcon'); 

        if (canEdit) {
            if (addBtn) addBtn.style.display = 'flex';
            if (trashBtn) trashBtn.style.display = 'flex';
            if (toggleIcon) { toggleIcon.style.visibility = 'visible'; toggleIcon.style.pointerEvents = 'auto'; }
            const lockStyle = document.getElementById('perm-style-lock');
            if(lockStyle) lockStyle.remove();
        } else {
            if (addBtn) addBtn.style.display = 'none';
            if (trashBtn) trashBtn.style.display = 'none';
            if (toggleIcon) { toggleIcon.style.visibility = 'hidden'; toggleIcon.style.pointerEvents = 'none'; }
            
            if (!document.getElementById('perm-style-lock')) {
                const style = document.createElement('style');
                style.id = 'perm-style-lock';
                style.innerHTML = `
                    .product-checkbox { display: none !important; }
                    .col-action { pointer-events: none; opacity: 0.5; }
                    .inline-input { pointer-events: none; border: none; background: transparent; color: #334155; }
                    .img-container { cursor: default !important; pointer-events: none; }
                    .cat-text { cursor: default !important; pointer-events: none; }
                `;
                document.head.appendChild(style);
            }
        }
        if(cachedProducts.length > 0) renderTable(cachedProducts);
    }

    // ============================================================
    // 3. LẤY DỮ LIỆU
    // ============================================================
    function loadProductsRealtime() {
        if (!currentStoreId) return;
        const q = query(collection(db, "products"), where("storeId", "==", currentStoreId));
        onSnapshot(q, (snapshot) => {
            cachedProducts = [];
            snapshot.forEach((doc) => cachedProducts.push({ id: doc.id, ...doc.data() }));
            applyFiltersAndSort(); 
        });
    }

    function loadCategoriesRealtime() {
        if (!currentStoreId) return;
        const q = query(collection(db, "product_categories"), where("storeId", "==", currentStoreId), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            cachedCategories = [];
            snapshot.forEach((doc) => cachedCategories.push({ id: doc.id, ...doc.data() }));
            updateCategoryDropdownList();
        });
    }

    // ============================================================
    // 4. HIỂN THỊ BẢNG (RENDER TABLE) - ĐÃ KHÓA SỐ LƯỢNG
    // ============================================================
    
    window.applyFiltersAndSort = function() {
        let result = [...cachedProducts];
        const searchVal = document.getElementById('searchInput')?.value.toLowerCase() || '';
        
        if (searchVal) result = result.filter(p => (p.name && p.name.toLowerCase().includes(searchVal)) || (p.sku && String(p.sku).toLowerCase().includes(searchVal)));
        if (currentCategory !== 'all') result = result.filter(p => (p.category || 'Chưa phân loại') === currentCategory);
        
        if (currentSortType === 'stock-asc') result.sort((a, b) => Number(a.stock||0) - Number(b.stock||0));
        else if (currentSortType === 'stock-desc') result.sort((a, b) => Number(b.stock||0) - Number(a.stock||0));
        else if (currentSortType === 'name-asc') result.sort((a, b) => (a.name||'').localeCompare(b.name||'', 'vi'));
        else if (currentSortType === 'name-desc') result.sort((a, b) => (b.name||'').localeCompare(a.name||'', 'vi'));
        else if (currentSortType === 'date-asc') result.sort((a, b) => new Date(a.expiryDate || '2099-12-31') - new Date(b.expiryDate || '2099-12-31'));
        else if (currentSortType === 'date-desc') result.sort((a, b) => new Date(b.expiryDate || '1970-01-01') - new Date(a.expiryDate || '1970-01-01'));

        renderTable(result);
    };

    function renderTable(list) {
        const body = document.getElementById('product-list-body');
        if (!body) return;
        
        const NO_IMG = 'https://placehold.co/300x300/png?text=No+Image';

        body.innerHTML = list.map((p) => {
            const stock = Number(p.stock) || 0;
            const cost = Number(p.cost) || 0;
            const total = stock * cost;
            const formattedTotal = total.toLocaleString('vi-VN');
            const imgSrc = (p.img && p.img.length > 50) ? p.img : NO_IMG;
            const isLowStock = stock <= 5; 

            // Logic quyền
            const inputAttr = canEdit ? '' : 'disabled';
            const imgClick = canEdit ? `onclick="document.getElementById('file-${p.id}').click()"` : '';
            const imgFile = canEdit ? `<input type="file" id="file-${p.id}" hidden accept="image/*" onchange="window.changeProductImage('${p.id}', this)">` : '';
            const catClick = canEdit ? `onclick="window.openQuickCategory(event, '${p.id}', '${p.category || ''}')"` : '';
            const actionContent = canEdit 
                ? `<input type="checkbox" class="product-checkbox" data-id="${p.id}" onchange="window.updateSelectedUI()">`
                : `<i class="fa-solid fa-lock" style="color:#cbd5e1;"></i>`;

            return `
                <tr id="row-${p.id}">
                    <td class="col-img">
                        <div class="img-container" ${imgClick}>
                            <img src="${imgSrc}" loading="lazy" style="object-fit:cover;">
                            ${imgFile}
                        </div>
                    </td>
                    <td class="col-name">
                        <input type="text" value="${p.name || ''}" class="inline-input product-name-text" ${inputAttr}
                            onchange="window.updateInlineField('${p.id}', 'name', this.value)">
                    </td>
                    <td class="col-sku">
                        <input type="text" value="${p.sku || ''}" class="inline-input sku-badge" ${inputAttr}
                        onchange="window.updateInlineField('${p.id}', 'sku', this.value)">
                    </td>
                    <td class="col-cat">
                        <span class="cat-text ${!p.category ? 'cat-unassigned' : ''}" ${catClick}>
                            ${p.category || '<i class="fa-solid fa-triangle-exclamation"></i> Trống'} 
                        </span>
                    </td>
                    
                    <!-- ============================================== -->
                    <!-- ĐÃ SỬA: KHÓA NHẬP SỐ LƯỢNG CHO TẤT CẢ MỌI NGƯỜI -->
                    <!-- ============================================== -->
                    <td class="col-stock">
                        <div style="
                            font-weight: 800; 
                            color:${isLowStock ? '#ef4444' : '#22c55e'}; 
                            background: #f8fafc; 
                            padding: 0px 12px; 
                            border-radius: 8px; 
                            text-align: center; 
                            border: 1px solid #e2e8f0;
                            display: inline-block;
                            min-width: 40px;">
                            ${stock}
                        </div>
                    </td>
                    <!-- ============================================== -->

                    <td class="col-unit">
                        <input type="text" value="${p.unit || ''}" class="inline-input" ${inputAttr} placeholder="Cái"
                        onchange="window.updateInlineField('${p.id}', 'unit', this.value)">
                    </td>
                    <td class="col-cost">
                        <input type="number" value="${cost}" class="inline-input" ${inputAttr} 
                        onchange="window.updateInlineField('${p.id}', 'cost', this.value)">
                    </td>
                    <td class="col-total">
                        <span style="font-weight:800; color:#0056e0;">${formattedTotal}</span> <span style="font-size:10px;">đ</span>
                    </td>
                    <td class="col-action" style="text-align:center;">
                        ${actionContent}
                    </td>
                </tr>`;
        }).join('');

        if (canEdit) window.updateSelectedUI();
    }

    // ============================================================
    // 5. CÁC HÀM XỬ LÝ 
    // ============================================================

    window.updateInlineField = async function(id, field, value) {
        if (!canEdit) return; 
        // Chặn thêm 1 lớp nữa cho chắc, không cho update stock qua hàm này
        if (field === 'stock') return; 

        try {
            let val = value;
            if(['cost', 'price', 'minStock'].includes(field)) val = Number(value);
            await updateDoc(doc(db, "products", id), { [field]: val });
        } catch (e) { alert("Lỗi: " + e.message); }
    };

    window.changeProductImage = function(id, fileInput) {
        if (!canEdit) return; 
        const file = fileInput.files[0];
        if (!file) return;
        const container = fileInput.closest('.img-container');
        container.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        compressImage(file, 25).then(async (base64) => {
            await updateDoc(doc(db, "products", id), { img: base64 });
        });
    };

    window.openQuickCategory = (e, id, currentCat) => {
        if (!canEdit) return; 
        e.stopPropagation();
        currentEditingId = id;
        const popup = document.getElementById('quickCategoryPopup');
        const ul = document.getElementById('quickCatList');
        document.getElementById('quickCatSearch').value = '';
        let catNames = cachedCategories.map(c => c.name);
        if (currentCat && currentCat !== 'Chưa phân loại' && !catNames.includes(currentCat)) catNames.push(currentCat);
        catNames.sort();
        let html = `<li style="color:#ef4444; font-weight:bold; border-bottom:1px solid #f1f5f9;" onclick="window.applyQuickCategory('')"><i class="fa-solid fa-eraser"></i> Xóa danh mục</li>`;
        catNames.forEach(c => html += `<li onclick="window.applyQuickCategory('${c}')">${c}</li>`);
        ul.innerHTML = html;
        const rect = e.currentTarget.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        popup.style.top = (rect.bottom + scrollTop + 5) + 'px';
        popup.style.left = (rect.left - 10) + 'px';
        popup.style.display = 'block';
    };

    window.applyQuickCategory = async (newCat) => {
        if (!canEdit || !currentEditingId) return;
        document.getElementById('quickCategoryPopup').style.display = 'none';
        try {
            await updateDoc(doc(db, "products", currentEditingId), { category: newCat });
            if (newCat && newCat.trim() !== "") {
                const exists = cachedCategories.some(c => c.name.toLowerCase() === newCat.trim().toLowerCase());
                if (!exists) {
                    await addDoc(collection(db, "product_categories"), {
                        name: newCat.trim(), storeId: currentStoreId, createdAt: serverTimestamp()
                    });
                }
            }
        } catch (e) { console.error(e); }
    };

    window.deleteSelectedProducts = async () => {
        if (!canEdit) { alert("Bạn không có quyền xóa sản phẩm!"); return; }
        const selected = document.querySelectorAll('.product-checkbox:checked');
        if (selected.length === 0) return;
        if (confirm(`Xóa vĩnh viễn ${selected.length} sản phẩm?`)) {
            const batch = writeBatch(db);
            selected.forEach(cb => batch.delete(doc(db, "products", cb.dataset.id)));
            try {
                await batch.commit();
                document.getElementById('toggleAllIcon').className = "fa-regular fa-square-minus";
                window.updateSelectedUI();
            } catch (e) { alert("Lỗi xóa: " + e.message); }
        }
    };
    
    // UI Helpers
    window.toggleAllCheckboxes = () => {
        if (!canEdit) return;
        const checkboxes = document.querySelectorAll('.product-checkbox');
        const icon = document.getElementById('toggleAllIcon');
        const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !isAllChecked);
        icon.className = !isAllChecked ? "fa-solid fa-square-check" : "fa-regular fa-square-minus";
        window.updateSelectedUI();
    };

    window.updateSelectedUI = () => {
        if (!canEdit) return;
        const selected = document.querySelectorAll('.product-checkbox:checked');
        const trashBtn = document.getElementById('mainTrashBtn');
        document.querySelectorAll('#product-list-body tr').forEach(tr => tr.classList.remove('selected-row'));
        selected.forEach(cb => document.getElementById(`row-${cb.dataset.id}`)?.classList.add('selected-row'));
        if (trashBtn) {
            if (selected.length > 0) {
                trashBtn.classList.add('active'); trashBtn.innerHTML = `<i class="fa-solid fa-trash-can"></i> (${selected.length})`;
            } else { trashBtn.classList.remove('active'); trashBtn.innerHTML = `<i class="fa-solid fa-trash-can"></i>`; }
        }
    };

    function compressImage(file, maxSizeKB) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image(); img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX = 400; let w=img.width, h=img.height;
                    if(w>h){if(w>MAX){h=Math.round(h*(MAX/w));w=MAX;}}else{if(h>MAX){w=Math.round(w*(MAX/h));h=MAX;}}
                    canvas.width=w; canvas.height=h;
                    const ctx = canvas.getContext('2d'); ctx.fillStyle="#FFF"; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            };
        });
    }

    // Dropdowns & Sidebar
    window.onclick = function(e) {
        if (!e.target.closest('.custom-select-container')) document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
        const popup = document.getElementById('quickCategoryPopup');
        if (popup && popup.style.display === 'block' && !e.target.closest('#quickCategoryPopup') && !e.target.closest('.cat-text')) popup.style.display = 'none';
    };

    
    window.toggleDropdown = () => document.getElementById('categoryContent').classList.toggle('show');
    window.selectCategory = (c) => { currentCategory=c; document.getElementById('selectedCategoryText').innerText=c; window.applyFiltersAndSort(); };
    window.toggleSortDropdown = () => document.getElementById('sortContent').classList.toggle('show');
    window.applySort = (t,l) => { currentSortType=t; document.getElementById('selectedSortText').innerText='Sắp xếp: '+l; window.applyFiltersAndSort(); };
    window.searchProducts = () => window.applyFiltersAndSort();
    window.filterCategoryList = () => {
        const v = document.getElementById('categorySearch').value.toLowerCase();
        document.querySelectorAll('#categoryList li:not(.cat-item-special)').forEach(li=>li.style.display=li.innerText.toLowerCase().includes(v)?'':'none');
    }
    window.filterQuickCategory = () => {
        const v = document.getElementById('quickCatSearch').value.toLowerCase();
        const lis = document.querySelectorAll('#quickCatList li:not(:first-child)');
        let has = false;
        lis.forEach(li => {
            if(li.innerText.toLowerCase().includes(v)) { li.style.display='block'; has=true; } else li.style.display='none';
        });
        let create = document.getElementById('li-create-cat');
        if(!has && v){
            if(!create){create=document.createElement('li'); create.id='li-create-cat'; create.style.color='blue'; create.onclick=()=>window.applyQuickCategory(v); document.getElementById('quickCatList').appendChild(create);}
            create.innerText = `+ Tạo: ${v}`; create.style.display='block';
        } else if(create) create.style.display='none';
    };
    document.addEventListener("DOMContentLoaded", function() {
        const t = document.querySelector('.table-container'); const w = document.getElementById('waterLevel');
        if (t && w) t.addEventListener('scroll', function() {
            const p = (t.scrollHeight - t.clientHeight) > 0 ? (t.scrollTop / (t.scrollHeight - t.clientHeight)) : 0;
            w.style.height = (15 + (p * 85)) + "%";
        });
    });

</script>

</body>

</html>
